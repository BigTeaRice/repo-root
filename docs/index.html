<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é›¶åç«¯è¡Œæƒ… + å›æµ‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Chart.js å¯è§†åŒ– -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;margin:0;padding:0 8px;background:#f7f7f7;}
    header{background:#111;color:#fff;padding:12px 16px;font-size:20px;font-weight:700;}
    .bar{display:flex;gap:12px;align-items:center;padding:12px 16px;background:#fff;border-bottom:1px solid #e5e5e5;}
    .bar select,.bar input,.bar button{height:36px;font-size:14px;}
    .bar button{padding:0 16px;background:#111;color:#fff;border:0;border-radius:4px;cursor:pointer;}
    .bar button:hover{background:#333;}
    #canvas{background:#fff;margin:16px auto;max-width:1200px;}
    #log{background:#fff;margin:16px auto;max-width:1200px;padding:16px;font-size:13px;white-space:pre-wrap;height:200px;overflow:auto;border:1px solid #e5e5e5;}
  </style>
</head>
<body>
  <header>é›¶åç«¯è¡Œæƒ… + å›æµ‹</header>

  <div class="bar">
    <label>ç¾è‚¡ (15min)
      <select id="symbol">
        <option value="AAPL">AAPL</option>
        <option value="MSFT">MSFT</option>
        <option value="NVDA">NVDA</option>
      </select>
    </label>

    <label>å‘¨æœŸ
      <select id="range">
        <option value="5">5æ—¥</option>
        <option value="30">1æœˆ</option>
        <option value="365">1å¹´</option>
      </select>
    </label>

    <button onclick="fetchData()">æŸ¥è¯¢</button>
    <button onclick="backtest()">å›æµ‹</button>
    <button onclick="aiAnalysis()">äººå·¥æ™ºèƒ½åˆ†æ</button>
  </div>

  <!-- å›¾è¡¨ -->
  <div id="canvas"><canvas id="priceChart"></canvas></div>

  <!-- å›æµ‹/åˆ†ææ—¥å¿— -->
  <div id="log"></div>

  <script>
    /* ========== å…¨å±€å˜é‡ ========== */
    let chart;                          // Chart.js å®ä¾‹
    const logBox = document.getElementById('log');

    /* ========== å·¥å…·å‡½æ•° ========== */
    function print(...args){ logBox.textContent += args.join(' ') + '\n'; logBox.scrollTop = logBox.scrollHeight; }

    /* ========== 1. æ‹‰è¡Œæƒ… ========== */
    async function fetchData(){
      const sym = document.getElementById('symbol').value;
      print(`æ‹‰å– ${sym} è¡Œæƒ…...`);
      try{
        // â‘  å…ˆå°è¯•é™æ€æ–‡ä»¶ï¼šdocs/data/${sym}_15m.json
        const res = await fetch(`./data/${sym}_15m.json?t=${Date.now()}`);
        if(!res.ok) throw new Error('é™æ€æ•°æ®ä¸å­˜åœ¨ â†’ è·³è½¬åˆ°å‡æ•°æ®æ¼”ç¤º');
        const arr = await res.json();
        renderChart(arr);
        print(`âœ… æ‹¿åˆ° ${arr.length} æ¡ K çº¿`);
      }catch(e){
        print('âš ï¸  é™æ€æ•°æ®å¤±è´¥ï¼Œç”¨å‡æ•°æ®æ¼”ç¤º\n', e.message);
        // â‘¡  fallbackï¼šç°åœºä¼ªé€  200 æ¡éšæœº K çº¿
        const mock = genMockKline(200);
        renderChart(mock);
      }
    }

    /* ========== 2. å›æµ‹ï¼šMA é‡‘å‰æ­»å‰ ========== */
    function backtest(){
      if(!chart || !chart.data.datasets.length){ print('âŒ è¯·å…ˆâ€œæŸ¥è¯¢â€æ‹¿åˆ°æ•°æ®'); return; }
      const data = chart.data.datasets[0].data;   // æ”¶ç›˜ä»·æ•°ç»„
      const n1 = 5, n2 = 20;
      let ma1 = SMA(data, n1), ma2 = SMA(data, n2);
      let pos = 0, cash = 10000, hold = 0, trades = 0;
      for(let i = n2; i < data.length; i++){
        const price = data[i];
        if(ma1[i] > ma2[i] && pos <= 0){          // é‡‘å‰ä¹°
          hold = Math.floor(cash / price);
          cash -= hold * price;
          pos = 1; trades++;
          print(`ğŸ“ˆ é‡‘å‰ä¹°å…¥ @ ${price.toFixed(2)} è‚¡æ•° ${hold}`);
        }else if(ma1[i] < ma2[i] && pos > 0){    // æ­»å‰å–
          cash += hold * price;
          print(`ğŸ“‰ æ­»å‰å–å‡º @ ${price.toFixed(2)} è‚¡æ•° ${hold}`);
          pos = 0; hold = 0;
        }
      }
      const final = cash + hold * data[data.length-1];
      print(`\nğŸ§¾ æ€»äº¤æ˜“ ${trades} æ¬¡ï¼Œæœ€ç»ˆå‡€å€¼ ${final.toFixed(2)}ï¼Œæ”¶ç›Šç‡ ${((final/10000-1)*100).toFixed(2)}%`);
    }

    /* ========== 3. AI åˆ†æï¼ˆå ä½ï¼‰ ========== */
    function aiAnalysis(){
      print('ğŸ¤– äººå·¥æ™ºèƒ½åˆ†æï¼šå½“å‰ç­–ç•¥åŸºäº MA é‡‘å‰æ­»å‰ï¼Œå»ºè®®åœ¨éœ‡è¡å¸‚ä¸­é…åˆ RSI è¿‡æ»¤ï¼Œå‡å°‘å‡ä¿¡å·ã€‚');
    }

    /* ========== 4. ç”» Chart ========== */
    function renderChart(priceArr){
      const labels = priceArr.map((_,i)=>i);
      if(chart){ chart.destroy(); }
      chart = new Chart(document.getElementById('priceChart'),{
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'Close',
            data:priceArr,
            borderColor:'#111',
            tension:0.1
          }]
        },
        options:{
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:false}}
        }
      });
    }

    /* ========== 5. å·¥å…·ï¼šSMA  ========== */
    function SMA(arr, n){
      const out = [];
      let sum = 0;
      for(let i = 0; i < arr.length; i++){
        sum += arr[i];
        if(i >= n) sum -= arr[i-n];
        out[i] = i >= n-1 ? sum/n : null;
      }
      return out;
    }

    /* ========== 6. å·¥å…·ï¼šç”Ÿæˆå‡ K çº¿ ========== */
    function genMockKline(count){
      const out = []; let base = 150;
      for(let i = 0; i < count; i++){
        base += (Math.random()-0.49)*2;
        out.push(Number(base.toFixed(2)));
      }
      return out;
    }

    /* ========== 7. é»˜è®¤è‡ªåŠ¨æŸ¥ä¸€æ¬¡ ========== */
    fetchData();
  </script>
</body>
</html>
