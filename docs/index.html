<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é›¶åç«¯è¡Œæƒ… + å›æµ‹</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
:root{--bg:#f4f6fa;--card:#fff;--text:#333;--accent:#2962ff;--profit:#0f0;--loss:#f00}
@media (prefers-color-scheme: dark){
 :root{--bg:#121212;--card:#1e1e1e;--text:#eee;--accent:#82b1ff;--profit:#4caf50;--loss:#f44336}
}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:20px auto;padding:10px}
.card{background:var(--card);border-radius:12px;padding:15px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.15)}
h1{text-align:center}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select{flex:1;padding:10px;border:1px solid #bbb;border-radius:6px;background:var(--card);color:var(--text)}
button{padding:10px 16px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer}
#chart{width:100%;height:460px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax 130px,1fr));gap:10px;font-size:.9rem}
.item{padding:8px;border-radius:6px;background:var(--bg)}
.item span:first-child{opacity:.7}
.item span:last-child{font-weight:600}}
#time{font-size:.8rem;opacity:.6;text-align:right;margin-top:8px}
.btn-row{margin-top:10px;display:flex;gap:10px;justify-content:flex-end}
</style>
</head>
<body>
<div class="container">
  <h1>é›¶åç«¯è¡Œæƒ… + å›æµ‹</h1>

  <!-- æŸ¥è¯¢ + æŒ‰é’®å³å¯¹é½ -->
  <div class="card row">
    <select id="market">
      <option value="us">ç¾è‚¡ (15min)</option>
      <option value="hk">æ¸¯è‚¡ (15min)</option>
    </select>
    <input id="symbol" placeholder="ä»£ç  e.g. AAPL, 0700" value="AAPL">
    <select id="range">
      <option value="1d">1 æ—¥</option>
      <option value="5d">5 æ—¥</option>
      <option value="1mo">1 æœˆ</option>
      <option value="3mo">3 æœˆ</option>
      <option value="6mo">6 æœˆ</option>
      <option value="1y">1 å¹´</option>
      <option value="2y">2 å¹´</option>
      <option value="5y">5 å¹´</option>
      <option value="10y">10 å¹´</option>
    </select>
    <button onclick="fetchData()">æŸ¥è¯¢</button>
  </div>

  <!-- æŒ‰é’®å³å¯¹é½ï¼šå›æµ‹ + AI -->
  <div class="card btn-row">
    <button onclick="backtest()">å›æµ‹</button>
    <button onclick="aiAnalysis()">äººå·¥æ™ºèƒ½åˆ†æ</button>
  </div>

  <div class="card">
    <div class="grid" id="info"></div>
    <div id="time"></div>
  </div>

  <div class="card">
    <div id="chart"></div>
  </div>

  <div class="card" id="backtest-card" style="display:none;">
    <h3>å›æµ‹ç»“æœ</h3>
    <div class="grid" id="backtest-info"></div>
  </div>
</div>

<script>
const $ = q => document.querySelector(q);
const market = $('#market'), symbol = $('#symbol'), range = $('#range'), info = $('#info'), myChart = echarts.init($('#chart')), backtestCard = $('#backtest-card'), backtestInfo = $('#backtest-info'));

// 30 ç§’è‡ªå‹•åˆ·æ–°
setInterval(() => {
  if (symbol.value.trim()) fetchData();
}, 30000);

// ============= æ•°æ®æº =============
async function fetchData() {
  const sym = symbol.value.trim().toUpperCase();
  const mkt = market.value;
  if (!sym) return;
  const file = sym.toLowerCase().replace('.', '_') + '.json';
  const url = `data/${file}?t=${Date.now()}`;
  const json = await fetch(url).then(r => r.json()).catch(() => null);
  if (!json || !json.data) {
    info.innerHTML = '<div class="item">åç«¯æ— æ•°æ®</div>';
    myChart.clear();
    return;
  }
  const now = new Date();
  const cut = new Date(now - parseRange(range.value));
  const bars = json.data.filter(it => new Date(it.datetime) >= cut);
  if (bars.length === 0) {
    info.innerHTML = '<div class="item">æŸ¥ç„¡è³‡æ–™<br>å»ºè®®æ¢æ—¥æœŸèŒƒå›´</div>';
    myChart.clear();
    return;
  }
  const ind = calcIndicators(bars);
  renderInfo(bars, ind);
  renderChart(bars, ind);
  $('#time').innerText = 'æ›´æ–°: ' + new Date().toLocaleString();
}

// ============= å›æµ‹åŠŸèƒ½ =============
async function backtest() {
  const sym = symbol.value.trim().toUpperCase();
  const mkt = market.value;
  if (!sym) return;
  const file = sym.toLowerCase().replace('.', '_') + '.json';
  const json = await fetch(url).then(r => r.json()).catch(() => null);
  if (!json || !json.data) {
    backtestInfo.innerHTML = '<div class="item">æ— æ•°æ®</div>';
    backtestCard.style.display = 'none';
    return;
  }
  const now = new Date();
  const cut = new Date(now - parseRange(range.value));
  const bars = json.data.filter(it => new Date(it.datetime) >= cut);
  if (bars.length === 0) {
    backtestInfo.innerHTML = '<div class="item">æ— æ•°æ®</div>';
    backtestCard.style.display = 'none';
    return;
  }
  // å›æµ‹ï¼šMA é‡‘å‰æ­»å‰
  const trades = [];
  let holding = false, entryPrice = 0;
  for (let i = 1; i < bars.length; i++) {
    const prev = bars[i - 1], curr = bars[i];
    const ma5 = avg(bars.slice(Math.max(0, i - 4), i + 1).map(it => it.c));
    const ma20 = avg(bars.slice(Math.max(0, i - 19), i + 1).map(it => it.c));
    if (!holding && ma5 > ma20 && prev.c < prev.ma20) { // é‡‘å‰
      holding = true;
      entryPrice = curr.c;
      trades.push({ type: 'BUY', price: entryPrice, date: curr.t });
    } else if (holding && ma5 < ma20 && prev.c > prev.ma20) { // æ­»å‰
      holding = false;
      const profit = (curr.c - entryPrice) / entryPrice;
      trades.push({ type: 'SELL', price: curr.c, profit: profit, date: curr.t });
    }
  }
  const win = trades.filter(t => t.type === 'SELL' && t.profit > 0).length;
  const total = trades.filter(t => t.type === 'SELL').length;
  const winRate = total ? (win / total * 100).toFixed(1) : '0.0';
  const pnl = trades.filter(t => t.type === 'SELL').reduce((s, t) => s + t.profit, 0);
  backtestInfo.innerHTML = `
    <div class="item"><span>äº¤æ˜“æ¬¡æ•°</span><span>${total}</span></div>
    <div class="item"><span>èƒœç‡</span><span>${winRate}%</span></div>
    <div class="item"><span>æ€»ç›ˆäº</span><span style="color:${pnl >= 0 ? 'var(--profit)' : 'var(--loss)'}}">${(pnl * 100).toFixed(2)}%</span></div>
  `;
  backtestCard.style.display = 'block';
}

// ============= æ–°å¢æŒ‰é’®åŠŸèƒ½ =============
function aiAnalysis() {
  alert('ğŸ¤– äººå·¥æ™ºèƒ½åˆ†æåŠŸèƒ½å³å°†ä¸Šçº¿ï¼\n\nâœ… æƒ…æ„Ÿåˆ†æ\nâœ… è¶‹åŠ¿é¢„æµ‹\nâœ… é£é™©è¯„åˆ†\n\næ•¬è¯·æœŸå¾…ï¼');
}

// ============= åˆå§‹åŒ– =============
fetchData();
</script>
</body>
</html>
