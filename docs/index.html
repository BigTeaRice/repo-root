<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è‚¡ç¥¨åˆ†æå·¥å…· - çº¯é™æ€ç‰ˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root{--primary:#111;--accent:#f59331;--bg:#f7f7f7;--card:#fff;}
    @media (prefers-color-scheme:dark){
      :root{--primary:#eee;--accent:#ffa726;--bg:#111;--card:#1e1e1e;}
      body{background:var(--bg);color:var(--primary);}
    }
    #mainChart,#volChart{background:var(--card);border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin:0 16px 16px;min-height:200px;}
    #log{background:#eee;color:#222;margin:16px;border-radius:6px;padding:12px;font-size:13px;white-space:pre-wrap;height:120px;overflow:auto;}
    @media (prefers-color-scheme:dark){#log{background:#222;color:#eee;}}
  </style>
</head>
<body class="bg-gray-100 font-sans m-0 pb-16">
<header class="bg-gray-800 text-white p-4 font-bold sticky top-0 z-10">è‚¡ç¥¨åˆ†æå·¥å…· - çº¯é™æ€ç‰ˆ</header>

<div class="flex flex-wrap gap-2 p-4 bg-white border-b items-center">
  <input id="symbol" type="text" placeholder="AAPL / 0700.HK" value="AAPL" class="p-2 border rounded text-sm flex-grow min-w-[100px]">
  <select id="range" class="p-2 border rounded text-sm">
    <option value="1d">1 å¤©</option><option value="5d">5 å¤©</option><option value="30d" selected>30 å¤©</option><option value="90d">90 å¤©</option><option value="180d">180 å¤©</option><option value="1y">1 å¹´</option>
  </select>
  <select id="ind" multiple title="Ctrl+å¤šé€‰" class="p-2 border rounded text-sm max-w-[180px]">
    <option value="MA" selected>ç§»åŠ¨å¹³å‡</option><option value="BB">å¸ƒæ—å¸¦</option><option value="RSI">RSI</option><option value="MACD">MACD</option>
  </select>
  <button onclick="fetchData()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">æŸ¥è¯¢</button>
</div>

<div class="flex flex-wrap p-4 gap-4">
  <div class="bg-white rounded shadow p-4 w-full sm:w-64">
    <div class="text-3xl font-bold text-orange-500" id="price">--</div>
    <div class="text-lg" id="change">--</div>
    <hr class="my-3">
    <div class="grid grid-cols-2 gap-2 text-sm text-gray-700">
      <div>MA5<span id="ma5" class="float-right font-medium">--</span></div>
      <div>MA10<span id="ma10" class="float-right font-medium">--</span></div>
      <div>MA20<span id="ma20" class="float-right font-medium">--</span></div>
      <div>RSI(14)<span id="rsi" class="float-right font-medium">--</span></div>
      <div>ATR(14)<span id="atr" class="float-right font-medium">--</span></div>
      <div>æˆäº¤é‡<span id="vol" class="float-right font-medium">--</span></div>
      <div>æ³¢å‹•ç‡<span id="volat" class="float-right font-medium">--</span></div>
      <div>Doji<span id="doji" class="float-right font-medium">--</span></div>
    </div>
  </div>
  <div class="bg-white rounded shadow flex-grow min-w-[300px] p-4">
    <div id="mainChart" style="height:360px;" class="mb-4"></div>
    <div id="volChart" style="height:180px;"></div>
  </div>
</div>

<div id="log" class="text-gray-700"></div>

<footer class="fixed bottom-0 left-0 right-0 bg-gray-800 flex justify-center gap-4 p-3 shadow z-10">
  <a href="./" class="text-white text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">ä¸»é¡µ</a>
  <a href="#" onclick="backtest();return false;" class="text-white text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">å›æµ‹</a>
  <a href="#" onclick="aiAnalysis();return false;" class="text-white text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">AI åˆ†æ</a>
</footer>

<script>
/* --------- å·¥å…· --------- */
const logBox=document.getElementById('log');
function print(...args){logBox.textContent+=args.join(' ')+'\n';logBox.scrollTop=logBox.scrollHeight;}
let ohlcvData=[],mainChart,volChart;

/* --------- æ•°æ®è·å– --------- */
async function fetchData(){
  const sym=document.getElementById('symbol').value.trim().toUpperCase();
  print(`æ‹‰å– ${sym} æ•°æ®...`);
  try{
    const res=await fetch(`./data/${sym}.json`);
    if(!res.ok) throw new Error('æ— æ­¤è‚¡ç¥¨æ•°æ®');
    const raw=await res.json();
    if(!raw.length) throw new Error('ç©ºæ•°æ®');
    ohlcvData=calcIndicators(raw);
    updateCard(ohlcvData[ohlcvData.length-1]);
    drawCharts(ohlcvData);
    print(`âœ… è¯»å– ${raw.length} æ¡è®°å½•`);
  }catch(e){
    print(`âŒ ${e.message}ï¼Œä½¿ç”¨å‡æ•°æ®æ¼”ç¤º`);
    const mock=genMockOHLCV(200);
    ohlcvData=calcIndicators(mock);
    updateCard(ohlcvData[ohlcvData.length-1]);
    drawCharts(ohlcvData);
  }
}

/* --------- æŠ€æœ¯æŒ‡æ ‡è®¡ç®— --------- */
function calcIndicators(data){
  const c=data.map(d=>d.c),o=data.map(d=>d.o),h=data.map(d=>d.h),l=data.map(d=>d.l),v=data.map(d=>d.v);
  const sma=(arr,n)=>arr.map((v,i)=>i<n-1?null:arr.slice(i-n+1,i+1).reduce((a,b)=>a+b)/n);
  const ma5=sma(c,5),ma10=sma(c,10),ma20=sma(c,20);
  const std=sma(c.map((v,i)=>Math.pow(v-ma20[i],2)),20).map(v=>Math.sqrt(v));
  const ub=ma20.map((v,i)=>v+2*std[i]),lb=ma20.map((v,i)=>v-2*std[i]);
  const rsi=(()=>{let up=0,down=0,out=[];for(let i=1;i<14;i++){const d=c[i]-c[i-1];up+=Math.max(d,0);down+=Math.max(-d,0)}let au=up/14,ad=down/14;out[13]=100-100/(1+au/(ad||1e-10));for(let i=14;i<c.length;i++){const d=c[i]-c[i-1];au=(au*13+Math.max(d,0))/14;ad=(ad*13+Math.max(-d,0))/14;out[i]=100-100/(1+au/(ad||1e-10))}return out})();
  const ema=(arr,n)=>arr.map((v,i)=>i?arr.slice(0,i+1).reduce((a,b,i,arr)=>a+(2/(n+1))*(b-a),arr[0]):arr[0]);
  const ema12=ema(c,12),ema26=ema(c,26);const macd=ema12.map((v,i)=>v-ema26[i]);const signal=ema(macd.filter((v,i)=>i>=25),9);
  const atr=(()=>{const tr=i=>Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1]));let out=[];for(let i=0;i<l.length;i++)out[i]=i?Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])):h[i]-l[i];for(let i=1;i<l.length;i++)out[i]=(out[i-1]*13+out[i])/14;return out})();
  return data.map((d,i)=>({...d,ma5:ma5[i],ma10:ma10[i],ma20:ma20[i],ub:ub[i],lb:lb[i],rsi:rsi[i],atr:atr[i],macd:macd[i],signal:signal[i-ma20.findIndex(v=>v!==null)]}));
}

/* --------- å¡ç‰‡æ›´æ–° --------- */
function updateCard(last){
  if(!ohlcvData.length)return;
  const prev=ohlcvData[ohlcvData.length-2];
  const chg=last.c-prev.c,chgP=(chg/prev.c*100).toFixed(2);
  document.getElementById('price').textContent=last.c.toFixed(2);
  document.getElementById('change').textContent=`${chg>0?'+':''}${chg.toFixed(2)} (${chgP}%)`;
  document.getElementById('change').className=`text-lg ${chg>0?'text-red-600':'text-green-600'}`;
  ['ma5','ma10','ma20','rsi','atr'].forEach(k=>document.getElementById(k).textContent=last[k]?last[k].toFixed(2):'--');
  document.getElementById('vol').textContent=(last.v/1e6).toFixed(1)+'M';
  const volat=last.atr?(last.atr/last.c*100).toFixed(2):'--';document.getElementById('volat').textContent=volat+'%';
  document.getElementById('doji').textContent=last.doji?'âœ…':'ç„¡';
}

/* --------- ç»˜å›¾ --------- */
function drawCharts(data){
  const dates=data.map(d=>d.t),ohlc=data.map(d=>[d.o,d.c,d.l,d.h]),vols=data.map(d=>d.v);
  const ind=Array.from(document.getElementById('ind').selectedOptions).map(o=>o.value);
  const series=[{name:'Kçº¿',type:'candlestick',data:ohlc,itemStyle:{color:'#ef232a',color0:'#14b143',borderColor:'#ef232a',borderColor0:'#14b143'}}];
  if(ind.includes('MA'))['ma5','ma10','ma20'].forEach((n,idx)=>series.push({name:n.toUpperCase(),type:'line',data:data.map(d=>d[n]),symbol:'none',lineStyle:{width:1.5,color:['#f59331','#4ecdc4','#45b7d1'][idx]}}));
  if(ind.includes('BB'))['ub','lb'].forEach(n=>series.push({name:n.toUpperCase(),type:'line',data:data.map(d=>d[n]),symbol:'none',lineStyle:{width:1,color:'#ffa726',type:'dashed'}}));
  if(ind.includes('RSI'))series.push({name:'RSI',type:'line',data:data.map(d=>d.rsi),symbol:'none',lineStyle:{width:1.5,color:'#ff00ff'}});
  if(ind.includes('MACD'))['macd','signal'].forEach((n,idx)=>series.push({name:n.toUpperCase(),type:'line',data:data.map(d=>d[n]),symbol:'none',lineStyle:{width:1.5,color:['#9c27b0','#00ffff'][idx]}}));
  const dojiData=data.map((d,i)=>d.doji?[i,d.h]:null).filter(v=>v);
  if(dojiData.length)series.push({name:'Doji',type:'scatter',symbol:'diamond',symbolSize:8,itemStyle:{color:'#ff9800'},data:dojiData});
  const option={animation:false,legend:{data:series.map(s=>s.name),inactiveColor:'#777',textStyle:{color:'#333'}},tooltip:{trigger:'axis',axisPointer:{type:'cross'},borderWidth:1,borderColor:'#ccc',padding:10,textStyle:{color:'#333'}},axisPointer:{link:[{xAxisIndex:'all'}],label:{backgroundColor:'#777'}},grid:[{left:'10%',right:'8%',top:'10%',height:'60%'}],xAxis:[{type:'category',data:dates,scale:true,boundaryGap:false,axisLine:{onZero:false},splitLine:{show:false},min:'dataMin',max:'dataMax'}],yAxis:[{scale:true,splitArea:{show:true},position:'right'}],dataZoom:[{type:'inside',xAxisIndex:[0],start:70,end:100}],series};
  if(!mainChart)mainChart=echarts.init(document.getElementById('mainChart'));mainChart.setOption(option);
  const volOption={animation:false,grid:[{left:'10%',right:'8%',top:'10%',height:'70%'}],xAxis:[{type:'category',data:dates,scale:true,boundaryGap:false,axisLine:{onZero:false},splitLine:{show:false},axisLabel:{show:false}}],yAxis:[{type:'value',splitNumber:2,axisLabel:{show:true,formatter:v=>(v/1e6)+'M'},axisLine:{show:false},axisTick:{show:false},splitLine:{show:false},position:'right'}],series:[{name:'Volume',type:'bar',data:vols.map((v,i)=>({value:v,itemStyle:{color:ohlc[i][1]>ohlc[i][0]?'#ef232a':'#14b143'}})),barWidth:'60%'}]};
  if(!volChart)volChart=echarts.init(document.getElementById('volChart'));volChart.setOption(volOption);
  window.onresize=()=>{mainChart.resize();volChart.resize();};
  mainChart.on('dataZoom',params=>volChart.dispatchAction({type:'dataZoom',start:params.start,end:params.end}));
  volChart.on('dataZoom',params=>mainChart.dispatchAction({type:'dataZoom',start:params.start,end:params.end}));
}

/* --------- å›æµ‹ --------- */
function backtest(){
  if(!ohlcvData.length){print('âŒ è¯·å…ˆæŸ¥è¯¢æ•°æ®');return;}
  const c=ohlcvData.map(d=>d.c);
  const ma5=c.map((v,i)=>i<4?null:c.slice(i-4,i+1).reduce((a,b)=>a+b)/5);
  const ma20=c.map((v,i)=>i<19?null:c.slice(i-19,i+1).reduce((a,b)=>a+b)/20);
  let pos=0,cash=10000,hold=0,trades=0;
  for(let i=20;i<c.length;i++){
    if(ma5[i]>ma20[i]&&pos<=0){hold=Math.floor(cash/c[i]);cash-=hold*c[i];pos=1;trades++;print(`ğŸ“ˆ é‡‘å‰ä¹°å…¥ @ ${c[i].toFixed(2)} è‚¡æ•° ${hold}`);}
    else if(ma5[i]<ma20[i]&&pos>0){cash+=hold*c[i];print(`ğŸ“‰ æ­»å‰å–å‡º @ ${c[i].toFixed(2)} è‚¡æ•° ${hold}`);pos=0;hold=0;}
  }
  const final=cash+(hold*c[c.length-1]);
  print(`\n================================\nğŸ§¾ äº¤æ˜“ ${trades} æ¬¡ï¼Œåˆå§‹å‡€å€¼ 10000.00\næœ€ç»ˆå‡€å€¼ ${final.toFixed(2)}ï¼Œæ”¶ç›Šç‡ ${((final/10000-1)*100).toFixed(2)}%\n================================`);
}

/* --------- AI æç¤º --------- */
function aiAnalysis(){print('ğŸ¤– åˆ†æï¼šå½“å‰ç­–ç•¥ä¸º MA é‡‘å‰æ­»å‰ã€‚\nå»ºè®®ï¼šåœ¨éœ‡è¡å¸‚ä¸­å¯åŠ å…¥ RSI>50 æˆ– ADX>25 è¿‡æ»¤ï¼Œå‡å°‘å‡ä¿¡å·ã€‚');}

/* --------- å‡æ•°æ®ç”Ÿæˆ --------- */
function genMockOHLCV(n){
  const mock=[];let last=100;const today=new Date();
  for(let i=0;i<n;i++){
    const d=new Date(today);d.setDate(today.getDate()-(n-1-i));
    const o=last*(1+(Math.random()-0.5)*0.01);
    const c=o*(1+(Math.random()-0.5)*0.012);
    const h=Math.max(o,c)*(1+Math.random()*0.005);
    const l=Math.min(o,c)*(1-Math.random()*0.005);
    const v=Math.floor(5000000*(0.8+Math.random()*0.4));
    const doji=Math.abs(o-c)<(h-l)*0.1;
    mock.push({t:d.toISOString().split('T')[0],o:+o.toFixed(2),h:+h.toFixed(2),l:+l.toFixed(2),c:+c.toFixed(2),v,doji});
    last=+c.toFixed(2);
  }
  return mock;
}

/* --------- åˆå§‹åŒ– --------- */
document.addEventListener('DOMContentLoaded',fetchData);
</script>
</body>
</html>
