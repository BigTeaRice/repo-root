<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è‚¡ç¥¨åˆ†æå·¥å…· - é›¶åç«¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--primary:#111;--accent:#f59331;--bg:#f7f7f7;--card:#fff;}
    *{box-sizing:border-box;}
    body{margin:0;padding:0 0 60px;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
    header{background:var(--primary);color:#fff;padding:12px 16px;font-size:18px;font-weight:700;position:sticky;top:0;z-index:10;}
    .top-bar{display:flex;flex-wrap:wrap;gap:10px;padding:12px 16px;background:var(--card);border-bottom:1px solid #e5e5e5;align-items:center;}
    .top-bar input,.top-bar select,.top-bar button{height:36px;font-size:14px;}
    .top-bar button{padding:0 16px;background:var(--primary);color:#fff;border:0;border-radius:4px;cursor:pointer;}
    .top-bar button:hover{background:#333;}
    .card{background:var(--card);border-radius:6px;padding:16px;margin:16px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
    .indicator-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;font-size:13px;}
    .indicator-grid div{display:flex;justify-content:space-between;}
    .price{font-size:28px;font-weight:700;color:var(--accent);}
    .change{font-size:16px;}
    canvas{background:var(--card);border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin:0 16px 16px;}
    #log{background:var(--card);margin:16px;border-radius:6px;padding:12px;font-size:13px;white-space:pre-wrap;height:120px;overflow:auto;}
    footer{position:fixed;bottom:0;left:0;right:0;background:var(--primary);display:flex;justify-content:center;gap:20px;padding:10px;}
    footer a{color:#fff;text-decoration:none;padding:8px 16px;background:#333;border-radius:4px;font-size:14px;}
    footer a:hover{background:#555;}
  </style>
</head>
<body>
  <header>è‚¡ç¥¨åˆ†æå·¥å…· - é›¶åç«¯</header>

  <div class="top-bar">
    <input id="symbol" type="text" placeholder="AAPL / 0700.HK" value="AAPL">
    <select id="range">
      <option value="1d">1 å¤©</option>
      <option value="5d">5 å¤©</option>
      <option value="30d" selected>30 å¤©</option>
      <option value="90d">90 å¤©</option>
      <option value="180d">180 å¤©</option>
      <option value="1y">1 å¹´</option>
    </select>
    <select id="ind" multiple title="Ctrl+å¤šé€‰">
      <option value="MA" selected>MA</option>
      <option value="BB">å¸ƒæ—</option>
      <option value="RSI">RSI</option>
      <option value="MACD">MACD</option>
    </select>
    <button onclick="fetchData()">æŸ¥è¯¢</button>
  </div>

  <!-- å®æ—¶å¡ç‰‡ -->
  <div class="card">
    <div class="price" id="price">--</div>
    <div class="change" id="change">--</div>
    <div class="indicator-grid">
      <div><span>MA5</span><span id="ma5">--</span></div>
      <div><span>MA20</span><span id="ma20">--</span></div>
      <div><span>RSI(14)</span><span id="rsi">--</span></div>
      <div><span>ATR(14)</span><span id="atr">--</span></div>
      <div><span>æˆäº¤é‡</span><span id="vol">--</span></div>
      <div><span>æ³¢åŠ¨ç‡</span><span id="volat">--</span></div>
    </div>
  </div>

  <!-- ä¸»å›¾ï¼šä»·æ ¼ + æŒ‡æ ‡ -->
  <canvas id="mainChart" height="300"></canvas>
  <!-- å‰¯å›¾â‘ ï¼šæˆäº¤é‡ -->
  <canvas id="volChart" height="180"></canvas>
  <!-- å‰¯å›¾â‘¡ï¼šRSI -->
  <canvas id="rsiChart" height="180"></canvas>
  <!-- å‰¯å›¾â‘¢ï¼šMACD -->
  <canvas id="macdChart" height="180"></canvas>

  <div id="log"></div>

  <!-- åº•éƒ¨å›ºå®šå¯¼èˆª -->
  <footer>
    <a href="./">è¿”å›ä¸»é </a>
    <a href="./backtest.html">å›æµ‹é¡µé¢</a>
    <a href="./ai.html">AI åˆ†æ</a>
  </footer>

  <script>
    /* --------- å·¥å…· --------- */
    const logBox = document.getElementById('log');
    function print(...args){ logBox.textContent += args.join(' ') + '\n'; logBox.scrollTop = logBox.scrollHeight; }

    let priceArr = [], volArr = [], mainChart, volChart, rsiChart, macdChart;

    /* --------- æ‹‰æ•°æ® --------- */
    async function fetchData(){
      const sym = document.getElementById('symbol').value.trim();
      const range = document.getElementById('range').value;
      print(`æ‹‰å– ${sym} ${range} è¡Œæƒ…...`);
      try{
        const file = sym.toLowerCase().replace('.','') + `_${range}.json`;
        const res = await fetch(`./data/${file}?t=${Date.now()}`);
        if(!res.ok) throw new Error('é™æ€æ–‡ä»¶ä¸å­˜åœ¨');
        const raw = await res.json();
        priceArr = raw.map(o=>o.c);
        volArr   = raw.map(o=>o.v);
        updateCard(raw[raw.length-1]);
        drawCharts(raw);
        print(`âœ… æ‹¿åˆ° ${raw.length} æ¡è®°å½•`);
      }catch(e){
        print('âš ï¸ é™æ€æ•°æ®å¤±è´¥ï¼Œç”¨å‡æ•°æ®æ¼”ç¤º');
        const mock = genMockOHLCV(200);
        priceArr = mock.map(o=>o.c);
        volArr   = mock.map(o=>o.v);
        updateCard(mock[mock.length-1]);
        drawCharts(mock);
      }
    }

    /* --------- æ›´æ–°å¡ç‰‡ --------- */
    function updateCard(last){
      const prev = priceArr[priceArr.length-2];
      const chg  = last.c - prev;
      const chgP = (chg/prev*100).toFixed(2);
      document.getElementById('price').textContent = last.c.toFixed(2);
      document.getElementById('change').textContent = `${chg>0?'+':''}${chg.toFixed(2)} (${chgP}%)`;
      document.getElementById('change').style.color = chg>0?'#e53e3e':'#4caf50';

      const ma5 = SMA(priceArr,5), ma20 = SMA(priceArr,20);
      const rsi = RSI(priceArr,14);
      const atr = ATR(priceArr,14);
      const vol = volArr.slice(-1)[0];
      const volat = (ATR(priceArr,14)/last.c*100).toFixed(2);

      document.getElementById('ma5').textContent  = ma5[ma5.length-1]?.toFixed(2) ?? '--';
      document.getElementById('ma20').textContent = ma20[ma20.length-1]?.toFixed(2) ?? '--';
      document.getElementById('rsi').textContent  = rsi[rsi.length-1]?.toFixed(2) ?? '--';
      document.getElementById('atr').textContent  = atr[atr.length-1]?.toFixed(2) ?? '--';
      document.getElementById('vol').textContent  = (vol/1e6).toFixed(1)+'M';
      document.getElementById('volat').textContent= volat+'%';
    }

    /* --------- ç”»å›¾è¡¨ --------- */
    function drawCharts(ohlcv){
      const labels = ohlcv.map((_,i)=>i);
      const indSel = Array.from(document.getElementById('ind').selectedOptions).map(o=>o.value);

      // 1. ä¸»å›¾ï¼šä»·æ ¼ + æŒ‡æ ‡ï¼ˆæ— æˆäº¤é‡ï¼‰
      const mainData = {
        labels,
        datasets: [{label: 'Close', data: priceArr, borderColor: '#111', backgroundColor: 'rgba(17,17,17,.05)', yAxisID: 'y', order: 0}]
      };
      if(indSel.includes('MA')){
        const ma5 = SMA(priceArr,5), ma20 = SMA(priceArr,20);
        mainData.datasets.push(
          {label: 'MA5',  data: ma5,  borderColor: '#f59331', borderWidth: 1.5, pointRadius: 0, yAxisID: 'y', order: 1},
          {label: 'MA20', data: ma20, borderColor: '#43a047', borderWidth: 1.5, pointRadius: 0, yAxisID: 'y', order: 1}
        );
      }
      if(indSel.includes('BB')){
        const bb = BB(priceArr,20);
        mainData.datasets.push(
          {label: 'UB', data: bb.ub, borderColor: 'rgba(244,67,54,.6)', borderWidth: 1, pointRadius: 0, yAxisID: 'y', order: 1},
          {label: 'LB', data: bb.lb, borderColor: 'rgba(244,67,54,.6)', borderWidth: 1, pointRadius: 0, yAxisID: 'y', order: 1}
        );
      }
      if(mainChart) mainChart.destroy();
      mainChart = new Chart(document.getElementById('mainChart'),{
        type: 'line',
        data: mainData,
        options: {responsive: true, maintainAspectRatio: false, interaction: {mode: 'index', intersect: false}, scales: {y: {grid: {color: 'rgba(0,0,0,.05)'}}}}
      });

      // 2. æˆäº¤é‡ç‹¬ç«‹å›¾
      if(volChart) volChart.destroy();
      volChart = new Chart(document.getElementById('volChart'),{
        type: 'bar',
        data: {labels, datasets: [{label: 'Volume', data: volArr, backgroundColor: 'rgba(66,133,244,.25)'}]},
        options: {responsive: true, maintainAspectRatio: false, scales: {y: {ticks: {callback: v=>(v/1e6)+'M'}}}}
      });

      // 3. RSI
      if(indSel.includes('RSI')){
        const rsi = RSI(priceArr,14);
        if(rsiChart) rsiChart.destroy();
        rsiChart = new Chart(document.getElementById('rsiChart'),{
          type: 'line',
          data: {labels, datasets: [{label: 'RSI(14)', data: rsi, borderColor: '#ff9800', tension: .1}]},
          options: {responsive: true, maintainAspectRatio: false, scales: {y: {min: 0, max: 100}}}
        });
      }else if(rsiChart){ rsiChart.destroy(); rsiChart=null; }

      // 4. MACD
      if(indSel.includes('MACD')){
        const macd = MACD(priceArr);
        if(macdChart) macdChart.destroy();
        macdChart = new Chart(document.getElementById('macdChart'),{
          type: 'bar',
          data: {labels, datasets: [
            {label: 'MACD', data: macd.macd, backgroundColor: 'rgba(66,133,244,.8)'},
            {label: 'Signal', data: macd.signal, backgroundColor: 'rgba(244,67,54,.8)'}
          ]},
          options: {responsive: true, maintainAspectRatio: false}
        });
      }else if(macdChart){ macdChart.destroy(); macdChart=null; }
    }

    /* --------- æŠ€æœ¯æŒ‡æ ‡ --------- */
    function SMA(arr, n){
      const out = []; let sum = 0;
      for(let i = 0; i < arr.length; i++){ sum += arr[i]; if(i >= n) sum -= arr[i - n]; out[i] = i >= n - 1 ? sum / n : null; }
      return out;
    }
    function BB(arr, n){
      const ma = SMA(arr, n), out = {ub: [], lb: []};
      for(let i = n - 1; i < arr.length; i++){
        const std = Math.sqrt(arr.slice(i - n + 1, i + 1).reduce((s, v) => s + (v - ma[i]) ** 2, 0) / n);
        out.ub[i] = ma[i] + 2 * std; out.lb[i] = ma[i] - 2 * std;
      }
      return out;
    }
    function RSI(arr, n = 14){
      const rsi = []; let up = 0, down = 0;
      for(let i = 1; i <= n; i++){ const d = arr[i] - arr[i - 1]; up += Math.max(d, 0); down += Math.max(-d, 0); }
      let avgUp = up / n, avgDown = down / n;
      for(let i = n; i < arr.length; i++){
        const d = arr[i] - arr[i - 1];
        avgUp = (avgUp * (n - 1) + Math.max(d, 0)) / n;
        avgDown = (avgDown * (n - 1) + Math.max(-d, 0)) / n;
        const rs = avgUp / (avgDown || 1);
        rsi[i] = 100 - 100 / (1 + rs);
      }
      return rsi;
    }
    function MACD(arr, fast = 12, slow = 26, signal = 9){
      const ema12 = EMA(arr, fast), ema26 = EMA(arr, slow);
      const macd = [];
      for(let i = slow - 1; i < arr.length; i++) macd[i] = (ema12[i] || 0) - (ema26[i] || 0);
      const sig = EMA(macd.filter(v => v != null), signal);
      const signalLine = [];
      for(let i = slow + signal - 2; i < arr.length; i++) signalLine[i] = sig[i - slow - signal + 2 + signal - 1] || 0;
      return {macd, signal: signalLine};
    }
    function EMA(arr, n){
      const k = 2 / (n + 1), out = []; let ema = arr[0];
      for(let i = 0; i < arr.length; i++){ ema = arr[i] * k + ema * (1 - k); out[i] = ema; }
      return out;
    }

    /* --------- åŠŸèƒ½ --------- */
    function backtest(){
      if(!priceArr.length){ print('âŒ è¯·å…ˆæŸ¥è¯¢æ•°æ®'); return; }
      const ma5 = SMA(priceArr,5), ma20 = SMA(priceArr,20);
      let pos = 0, cash = 10000, hold = 0, trades = 0;
      for(let i = 20; i < priceArr.length; i++){
        const price = priceArr[i];
        if(ma5[i] > ma20[i] && pos <= 0){
          hold = Math.floor(cash / price);
          cash -= hold * price; pos = 1; trades++;
          print(`ğŸ“ˆ é‡‘å‰ä¹°å…¥ @ ${price.toFixed(2)} è‚¡æ•° ${hold}`);
        }else if(ma5[i] < ma20[i] && pos > 0){
          cash += hold * price;
          print(`ğŸ“‰ æ­»å‰å–å‡º @ ${price.toFixed(2)} è‚¡æ•° ${hold}`);
          pos = 0; hold = 0;
        }
      }
      const final = cash + (hold * priceArr[priceArr.length - 1]);
      print(`\nğŸ§¾ äº¤æ˜“ ${trades} æ¬¡ï¼Œæœ€ç»ˆå‡€å€¼ ${final.toFixed(2)}ï¼Œæ”¶ç›Šç‡ ${((final/10000-1)*100).toFixed(2)}%`);
    }

    function aiAnalysis(){
      print('ğŸ¤– å½“å‰ç­–ç•¥ä¸º MA é‡‘å‰æ­»å‰ï¼Œå»ºè®®åœ¨éœ‡è¡å¸‚åŠ å…¥ RSI è¿‡æ»¤ï¼Œå‡å°‘å‡ä¿¡å·ã€‚');
    }

    /* --------- å‡æ•°æ® --------- */
    function genMockOHLCV(len){
      const out = []; let base = 150;
      for(let i = 0; i < len; i++){
        base += (Math.random() - 0.49) * 2;
        const c = Number(base.toFixed(2));
        const o = c + (Math.random() - 0.5) * 1;
        const h = c + Math.random() * 1;
        const l = c - Math.random() * 1;
        const v = Math.floor(Math.random() * 1e7);
        out.push({o, h, l, c, v, t: i});
      }
      return out;
    }

    /* --------- åˆå§‹åŠ è½½ --------- */
    fetchData();
  </script>
</body>
</html>
