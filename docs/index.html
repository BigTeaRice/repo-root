# 1. æ–°å»º index.htmlï¼ˆå¤åˆ¶æˆ‘æä¾›çš„å®Œæ•´å†…å®¹ï¼‰
cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å®æ—¶è¡Œæƒ… + å…¨å¥—æŠ€æœ¯æŒ‡æ ‡</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
:root{--bg:#f4f6fa;--card:#fff;--text:#333;--accent:#2962ff}
@media (prefers-color-scheme: dark){
 :root{--bg:#121212;--card:#1e1e1e;--text:#eee;--accent:#82b1ff'}
}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:20px auto;padding:10px}
.card{background:var(--card);border-radius:12px;padding:15px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.15)}
h1{text-align:center}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select{flex:1;padding:10px;border:1px solid #bbb;border-radius:6px;background:var(--card);color:var(--text)}
button{padding:10px 16px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer}
#chart{width:100%;height:460px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax 130px,1fr));gap:10px;font-size:.9rem}
.item{padding:8px;border-radius:6px;background:var(--bg)}
.item span:first-child{opacity:.7}
.item span:last-child{font-weight:600}}
#time{font-size:.8rem;opacity:.6;text-align:right;margin-top:8px}
.btn-row{margin-top:10px;display:flex;gap:10px}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ“ˆ å®æ—¶è¡Œæƒ… + å…¨å¥—æŠ€æœ¯æŒ‡æ ‡</h1>
  <div class="card row">
    <select id="market">
      <option value="us">ç¾è‚¡ (15min)</option>
      <option value="hk">æ¸¯è‚¡ (15min)</option>
      <option value="sz">æ·±åœ³ (æ—¥K)</option>
      <option value="sh">ä¸Šæµ· (æ—¥K)</option>
    </select>
    <input id="symbol" placeholder="ä»£ç  e.g. AAPL, 0700, 000001" value="AAPL">
    <select id="range">
      <option value="1d">1 æ—¥</option>
      <option value="5d">5 æ—¥</option>
      <option value="1mo">1 æœˆ</option>
      <option value="3mo">3 æœˆ</option>
      <option value="6mo">6 æœˆ</option>
      <option value="1y">1 å¹´</option>
      <option value="2y">2 å¹´</option>
      <option value="5y">5 å¹´</option>
      <option value="10y">10 å¹´</option>
    </select>
    <button onclick="fetchData()">æŸ¥è¯¢</button>
  </div>

  <div class="card">
    <div class="grid" id="info"></div>
    <div id="time"></div>
  </div>

  <div class="card">
    <div id="chart"></div>
  </div>

  <div class="card btn-row">
    <button onclick="location.href='/'">å›ä¸»é </button>
    <button onclick="aiAnalysis()">äººå·¥æ™ºèƒ½åˆ†æ</button>
  </div>
</div>

<script>
const $ = q => document.querySelector(q);
const market = $('#market'), symbol = $('#symbol'), range = $('#range'), info = $('#info'), myChart = echarts.init($('#chart'));

// 30 ç§’è‡ªå‹•åˆ·æ–°
setInterval(() => {
  if (symbol.value.trim()) fetchData();
}, 30000);

// ============= æ•°æ®æº =============
// 1) Yahoo Finance 15min Kï¼ˆç¾è‚¡ã€æ¸¯è‚¡ï¼‰â†’ ç”¨ GitHub Pages åç«¯ JSON
async function fetchYF(sym, exch) {
  const file = sym.toLowerCase().replace('.', '_') + '.json';
  const url = `data/${file}?t=${Date.now()}`;
  const json = await fetch(url).then(r => r.json()).catch(() => null);
  if (!json || !json.data) return null;
  // æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤
  const now = new Date();
  const cut = new Date(now - parseRange(range.value));
  return json.data.filter(it => new Date(it.datetime) >= cut);
}

// 2) AkShare æ—¥ Kï¼ˆæ·±åœ³ã€ä¸Šæµ·ï¼‰â†’ ç”¨ GitHub Pages åç«¯ JSON
async function fetchAk(sym) {
  const file = sym.toLowerCase().replace('.', '_') + '.json';
  const url = `data/${file}?t=${Date.now()}`;
  const json = await fetch(url).then(r => r.json()).catch(() => null);
  if (!json || !json.data) return null;
  // æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤
  const now = new Date();
  const cut = new Date(now - parseRange(range.value));
  return json.data.filter(it => new Date(it.datetime) >= cut);
}

// è§£ææ—¶é—´èŒƒå›´
function parseRange(val) {
  const map = { '1d': 1, '5d': 5, '1mo': 30, '3mo': 90, '6mo': 180, '1y': 365, '2y': 730, '5y': 1825, '10y': 3650 };
  return (map[val] || 30) * 24 * 60 * 60 * 1000;
}

// ============= æŠ€è¡“æŒ‡æ¨™ï¼ˆå‰ç«¯å³æ™‚è¨ˆç®—ï¼‰ =============
function calcIndicators(bars) {
  const n = bars.length;
  const c = bars.map(x => x.c);
  const h = bars.map(x => x.h);
  const l = bars.map(x => x.l);
  const o = bars.map(x => x.o);

  // 1) MA
  const ma5 = [], ma10 = [], ma20 = [];
  for (let i = 0; i < n; i++) {
    ma5.push(i >= 4 ? avg(c.slice(i - 4, i + 1)) : null);
    ma10.push(i >= 9 ? avg(c.slice(i - 9, i + 1)) : null);
    ma20.push(i >= 19 ? avg(c.slice(i - 19, i + 1)) : null);
  }

  // 2) RSI(14)
  const rsi = [null];
  for (let i = 1; i < n; i++) {
    const delta = c[i] - c[i - 1];
    const gain = Math.max(delta, 0);
    const loss = Math.max(-delta, 0);
    if (i === 1) { rsi.push(50); continue; }
    const avgGain = (rsi[i - 1] / 100 * (i - 1) + gain) / i;
    const avgLoss = ((100 - rsi[i - 1]) / 100 * (i - 1) + loss) / i;
    const rs = avgGain / avgLoss;
    rsi.push(100 - (100 / (1 + rs)));
  }

  // 3) ATR(14)
  const atr = [null];
  for (let i = 1; i < n; i++) {
    const tr = Math.max(h[i] - l[i], Math.abs(h[i] - c[i - 1]), Math.abs(l[i] - c[i - 1]));
    atr.push(i === 1 ? tr : (atr[i - 1] * 13 + tr) / 14);
  }

  // 4) MTM(12)
  const mtm = [];
  for (let i = 0; i < n; i++) mtm.push(i >= 11 ? c[i] / c[i - 11] - 1 : null);

  // 5) Doji æª¢æ¸¬
  const doji = bars.map((it, i) => {
    const body = Math.abs(it.c - it.o);
    const hl = it.h - it.l;
    return hl > 0 && body / hl < 0.001;
  });

  return { ma5, ma10, ma20, rsi, atr, mtm, doji };
}

function avg(arr) {
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}

// ============= æ¸²æŸ“ =============
async function fetchData() {
  const sym = symbol.value.trim().toUpperCase();
  const mkt = market.value;
  if (!sym) return;
  const bars = (mkt === 'us' || mkt === 'hk') ? await fetchYF(sym, mkt === 'us' ? 'US' : 'HK') : await fetchAk(sym);
  // âœ… æ·±/æ²ª 0 ç¬”ä¿åº•æç¤º
  if (!bars || bars.length === 0) {
    info.innerHTML = '<div class="item">æŸ¥ç„¡è³‡æ–™<br>å»ºè®®æ¢æ—¥æœŸèŒƒå›´</div>';
    myChart.clear();
    return;
  }
  const ind = calcIndicators(bars);
  renderInfo(bars, ind);
  renderChart(bars, ind);
  $('#time').innerText = 'æ›´æ–°: ' + new Date().toLocaleString();
}

function renderInfo(bars, ind) {
  const last = bars[bars.length - 1];
  const rsi = ind.rsi[ind.rsi.length - 1];
  const atr = ind.atr[ind.atr.length - 1];
  const mtm = ind.mtm[ind.mtm.length - 1];
  const isDoji = ind.doji[ind.doji.length - 1];
  info.innerHTML = `
    <div class="item"><span>æœ€æ–°åƒ¹</span><span>${last.c.toFixed(2)}</span></div>
    <div class="item"><span>æ¼²è·Œå¹…</span><span style="color:${last.c >= last.o ? '#0f0' : '#f00'}">${((last.c - last.o) / last.o * 100).toFixed(2)}%</span></div>
    <div class="item"><span>RSI(14)</span><span>${rsi ? rsi.toFixed(2) : '--'}</span></div>
    <div class="item"><span>ATR(14)</span><span>${atr ? atr.toFixed(2) : '--'}</span></div>
    <div class="item"><span>MTM(12)</span><span>${mtm ? (mtm * 100).toFixed(2) + '%' : '--'}</span></div>
    <div class="item"><span>åå­—æ˜Ÿ</span><span>${isDoji ? 'âœ…' : 'âŒ'}</span></div>
    <div class="item"><span>MA5</span><span>${ind.ma5[ind.ma5.length - 1]?.toFixed(2) || '--'}</span></div>
    <div class="item"><span>MA10</span><span>${ind.ma10[ind.ma10.length - 1]?.toFixed(2) || '--'}</span></div>
    <div class="item"><span>MA20</span><span>${ind.ma20[ind.ma20.length - 1]?.toFixed(2) || '--'}</span></div>
  '>;
}

function renderChart(bars, ind) {
  const times = bars.map(it => it.t.toLocaleTimeString());
  const c = bars.map(it => it.c);
  const ma5 = ind.ma5;
  const ma10 = ind.ma10;
  const ma20 = ind.ma20;
  const vol = bars.map(it => it.v);

  myChart.setOption({
    title: { text: `${symbol.value}  Kç·šèˆ‡æŠ€è¡“æŒ‡æ¨™`, left: 'center' },
    tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
    legend: { data: ['K', 'MA5', 'MA10', 'MA20'], top: 25 },
    grid: [{ left: '10%', right: '8%', top: '15%', height: '55%' }, { left: '10%', right: '8%', top: '75%', height: '12%' }],
    xAxis: [{ type: 'category', data: times, scale: true }, { type: 'category', gridIndex: 1, data: times, scale: true }],
    yAxis: [{ type: 'value', scale: true }, { type: 'value', scale: true, gridIndex: 1 }],
    dataZoom: [{ type: 'inside', xAxisIndex: [0, 1], start: 70, end: 100 }, { type: 'slider', xAxisIndex: [0, 1], start: 70, end: 100, top: '90%' }],
    series: [
      { name: 'K', type: 'candlestick', data: bars.map(it => [it.o, it.c, it.l, it.h]), itemStyle: { color: '#ef232a', color0: '#14b143' } },
      { name: 'MA5', type: 'line', data: ma5, smooth: true, lineStyle: { width: 1.5, color: '#c23531' }, symbol: 'none' },
      { name: 'MA10', type: 'line', data: ma10, smooth: true, lineStyle: { width: 1.5, color: '#ff9800' }, symbol: 'none' },
      { name: 'MA20', type: 'line', data: ma20, smooth: true, lineStyle: { width: 1.5, color: '#2c3e50' }, symbol: 'none' },
      { name: 'Volume', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: vol, itemStyle: { color: vol.map((_, i) => bars[i].c >= bars[i].o ? '#ef232a' : '#14b143') } }
    ]
  });
}

// ============= æ–°å¢æŒ‰é’®åŠŸèƒ½ =============
function aiAnalysis() {
  alert('ğŸ¤– äººå·¥æ™ºèƒ½åˆ†æåŠŸèƒ½å³å°†ä¸Šçº¿ï¼\n\nâœ… æƒ…æ„Ÿåˆ†æ\nâœ… è¶‹åŠ¿é¢„æµ‹\nâœ… é£é™©è¯„åˆ†\n\næ•¬è¯·æœŸå¾…ï¼');
}

// ============= åˆå§‹åŒ– =============
fetchData();
</script>
</body>
</html>
EOF

# 2. æ–°å»º update_realtime_json.pyï¼ˆå¤åˆ¶æˆ‘æä¾›çš„å®Œæ•´å†…å®¹ï¼‰
cat > update_realtime_json.py << 'EOF'
#!/usr/bin/env python3
"""
å®æ—¶è¡Œæƒ… â†’ JSONï¼ˆGitHub Actions / æœ¬åœ°é€šç”¨ï¼‰
- Yahoo Financeï¼šç¾è‚¡ã€æ¸¯è‚¡ 15min K
- AkShareï¼šæ·±åœ³ã€ä¸Šæµ· æ—¥ Kï¼ˆä¿åº• 30+5 å¤©ï¼ŒèŠ‚å‡ä¸ç©ºï¼‰
- è¾“å‡ºï¼šdocs/data/<symbol>.json
"""
import os
import json
import pandas as pd
import yfinance as yf
import akshare as ak
from datetime import datetime, timedelta

OUTPUT_DIR = "docs/data"
STOCKS = {
    'AAPL': 'yfinance',
    '0700.HK': 'yfinance',
    '000001': 'akshare',
    'MSFT': 'yfinance',
}
BAR_US_HK = '15m'          # Yahoo 15 åˆ†é’Ÿ
BAR_CN = 'daily'           # AkShare æ—¥ K
DEEP_DAYS = 30 + 5         # ä¿åº• 30 æ—¥ + 5 å¤©ä¿é™©

def ensure_dir():
    os.makedirs(OUTPUT_DIR, exist_ok=True)

def gmt_now():
    return datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')

def fetch_yf(sym, bar='15m', days=30):
    """Yahoo Finance 15min K"""
    ticker = sym.replace('.HK', '')
    df = yf.Ticker(ticker).history(period=f'{days}d', interval=bar).reset_index()
    df = df.rename(columns=str.lower)[['datetime','open','high','low','close','volume']]
    return df

def fetch_ak(sym, bar='daily', days=DEEP_DAYS) -> pd.DataFrame:
    """AkShare æ—¥ Kï¼ˆä¿åº• 30+5 å¤©ï¼ŒèŠ‚å‡ä¸ç©ºï¼‰"""
    ak_sym = ('sh' if sym.startswith('6') else 'sz') + sym
    end = datetime.now()
    start = end - timedelta(days=days)
    df = ak.stock_zh_a_hist(symbol=ak_sym[2:],
                            period=bar,
                            start_date=start.strftime('%Y%m%d'),
                            end_date=end.strftime('%Y%m%d'),
                            adjust='')
    if df.empty:
        raise RuntimeError(f"AkShare å›å‚³ç©º DataFrameï¼ˆç¯€å‡æ—¥ç„¡è³‡æ–™ï¼‰ï¼š{sym}")
    df = df.rename(columns={'æ—¥æœŸ': 'datetime', 'å¼€ç›˜': 'open', 'æœ€é«˜': 'high',
                            'æœ€ä½': 'low', 'æ”¶ç›˜': 'close', 'æˆäº¤é‡': 'volume'})
    df['datetime'] = pd.to_datetime(df['datetime'])
    return df

def calc_indicators(df: pd.DataFrame) -> pd.DataFrame:
    """å‰ç«¯å…¨å¥—æŠ€æœ¯æŒ‡æ ‡"""
    c = df['close']
    df['MA5'] = c.rolling(5).mean()
    df['MA10'] = c.rolling(10).mean()
    df['MA20'] = c.rolling(20).mean()
    # RSI(14)
    delta = c.diff()
    gain = delta.clip(lower=0)
    loss = -delta.clip(upper=0)
    rs = gain.rolling(14).mean() / loss.rolling(14).mean()
    df['RSI'] = 100 - (100 / (1 + rs))
    # ATR(14)
    hl = df['high'] - df['low']
    hcp = (df['high'] - c.shift()).abs()
    lcp = (df['low'] - c.shift()).abs()
    tr = pd.concat([hl, hcp, lcp], axis=1).max(axis=1)
    df['ATR'] = tr.rolling(14).mean()
    # MTM(12)
    df['MTM'] = c / c.shift(12) - 1
    # Doji
    body = (df['close'] - df['open']).abs()
    hl2 = df['high'] - df['low']
    df['DOJI'] = (hl2 > 0) & (body / hl2 < 0.001)
    return df.dropna(thresh=5)   # è‡³å°‘ 5 æ æœ‰å€¼å³å¯

def main():
    ensure_dir()
    for sym, src in STOCKS.items():
        try:
            if src == 'yfinance':
                df = fetch_yf(sym, bar=BAR_US_HK, days=30)
            else:
                df = fetch_ak(sym, bar=BAR_CN, days=DEEP_DAYS)
            df = calc_indicators(df)
            out = {
                "symbol": sym,
                "source": src,
                "updated": gmt_now(),
                "data": df.to_dict(orient='records')
            }
            file_name = sym.lower().replace('.', '_') + '.json'
            with open(os.path.join(OUTPUT_DIR, file_name), 'w', encoding='utf-8') as f:
                json.dump(out, f, ensure_ascii=False, default=str)
            print(f"âœ… {sym}  ->  {OUTPUT_DIR}/{file_name}  ({len(df)} ç­†)")
        except Exception as e:
            print(f"âŒ {sym} å¤±æ•—: {e}")

    # meta æ–‡ä»¶
    meta = {"build_time": gmt_now(), "stocks": list(STOCKS.keys())}
    with open(os.path.join(OUTPUT_DIR, "meta.json"), 'w', encoding='utf-8') as f:
        json.dump(meta, f, ensure_ascii=False, default=str)
    print("=== è¼¸å‡ºå®Œæˆ ===")

if __name__ == '__main__':
    main()
EOF

# 3. æäº¤å¹¶æ¨é€
git add docs/index.html update_realtime_json.py
git commit -m "fix: æ·±æ²ªä¿åº•30æ—¥+å‰ç«¯0ç¬”æç¤º+æ—¶é—´èŒƒå›´1æ—¥-10å¹´+åŒæŒ‰é’®"
git push origin main
