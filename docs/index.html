<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è‚¡ç¥¨åˆ†æå·¥å…· </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    :root{--primary:#111;--accent:#f59331;--bg:#f7f7f7;--card:#fff;}
    *{box-sizing:border-box;}
    body{margin:0;padding:0 0 60px;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
    header{background:var(--primary);color:#fff;padding:12px 16px;font-size:18px;font-weight:700;position:sticky;top:0;z-index:10;}
    .top-bar{display:flex;flex-wrap:wrap;gap:10px;padding:12px 16px;background:var(--card);border-bottom:1px solid #e5e5e5;align-items:center;}
    .top-bar input,.top-bar select,.top-bar button{height:36px;font-size:14px;}
    .top-bar button{padding:0 16px;background:var(--primary);color:#fff;border:0;border-radius:4px;cursor:pointer;}
    .top-bar button:hover{background:#333;}
    .container{display:flex;flex-wrap:wrap;padding:16px;gap:16px;}
    .card{flex:1 1 300px;background:var(--card);border-radius:6px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
    .indicator-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;font-size:13px;}
    .indicator-grid div{display:flex;justify-content:space-between;}
    .price{font-size:28px;font-weight:700;color:var(--accent);}
    .change{font-size:16px;}
    #mainChart,#volChart{background:var(--card);border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin:0 16px 16px;}
    #log{background:var(--card);margin:16px;border-radius:6px;padding:12px;font-size:13px;white-space:pre-wrap;height:120px;overflow:auto;}
    footer{position:fixed;bottom:0;left:0;right:0;background:var(--primary);display:flex;justify-content:center;gap:20px;padding:10px;}
    footer a{color:#fff;text-decoration:none;padding:8px 16px;background:#333;border-radius:4px;font-size:14px;}
    footer a:hover{background:#555;}
  </style>
</head>
<body>
  <header>è‚¡ç¥¨åˆ†æå·¥å…· - é›¶åç«¯ï¼ˆFallbackï¼‰</header>

  <div class="top-bar">
    <input id="symbol" type="text" placeholder="AAPL / 0700.HK" value="AAPL">
    <select id="range">
      <option value="1d">1 å¤©</option>
      <option value="5d">5 å¤©</option>
      <option value="30d" selected>30 å¤©</option>
      <option value="90d">90 å¤©</option>
      <option value="180d">180 å¤©</option>
      <option value="1y">1 å¹´</option>
    </select>
    <select id="ind" multiple title="Ctrl+å¤šé€‰">
      <option value="MA" selected>ç§»åŠ¨å¹³å‡ (MA)</option>
      <option value="BB">å¸ƒæ—å¸¦ (Bollinger)</option>
      <option value="RSI">ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡ (RSI)</option>
      <option value="MACD">MACD</option>
    </select>
    <button onclick="fetchData()">æŸ¥è¯¢</button>
  </div>

  <div class="container">
    <!-- å·¦ä¾§å®æ—¶å¡ç‰‡ -->
    <div class="card" style="flex:0 0 320px;">
      <div class="price" id="price">--</div>
      <div class="change" id="change">--</div>
      <hr>
      <div class="indicator-grid">
        <div><span>MA5</span><span id="ma5">--</span></div>
        <div><span>MA10</span><span id="ma10">--</span></div>
        <div><span>MA20</span><span id="ma20">--</span></div>
        <div><span>RSI(14)</span><span id="rsi">--</span></div>
        <div><span>ATR(14)</span><span id="atr">--</span></div>
        <div><span>æˆäº¤é‡</span><span id="vol">--</span></div>
        <div><span>æ³¢åŠ¨ç‡</span><span id="volat">--</span></div>
        <div><span>Dojä¿¡å·</span><span id="doji">--</span></div>
        <div><span>MTMä¿¡å·</span><span id="mtm">--</span></div>
      </div>
    </div>

    <!-- å³ä¾§ä¸»å›¾+å‰¯å›¾ -->
    <div class="card" style="flex:1 1 600px;">
      <div id="mainChart" style="height:360px;margin-bottom:16px;"></div>
      <div id="volChart" style="height:180px;"></div>
    </div>
  </div>

  <div id="log"></div>

  <!-- åº•éƒ¨å›ºå®šå¯¼èˆª -->
  <footer>
    <a href="./">è¿”å›ä¸»é </a>
    <a href="./backtest.html">å›æµ‹é¡µé¢</a>
    <a href="./ai.html">AI åˆ†æ</a>
  </footer>

  <script>
    /* --------- å·¥å…· --------- */
    const logBox = document.getElementById('log');
    function print(...args){ logBox.textContent += args.join(' ') + '\n'; logBox.scrollTop = logBox.scrollHeight; }

    let priceArr = [], volArr = [], mainChart, volChart;

    /* --------- æ‹‰æ•°æ® --------- */
    async function fetchData(){
      const sym = document.getElementById('symbol').value.trim();
      const range = document.getElementById('range').value;
      print(`æ‹‰å– ${sym} ${range} è¡Œæƒ…...`);
      try{
        const file = sym.toLowerCase().replace('.','') + `_${range}.json`;
        const res = await fetch(`./data/${file}?t=${Date.now()}`);
        if(!res.ok) throw new Error('é™æ€æ–‡ä»¶ä¸å­˜åœ¨');
        const raw = await res.json();
        priceArr = raw.map(o=>o.c);
        volArr   = raw.map(o=>o.v);
        updateCard(raw[raw.length-1]);
        drawCharts(raw);
        print(`âœ… æ‹¿åˆ° ${raw.length} æ¡è®°å½•`);
      }catch(e){
        print('âš ï¸ é™æ€æ•°æ®å¤±è´¥ï¼Œç”¨å‡æ•°æ®æ¼”ç¤º');
        const mock = genMockOHLCV(200);
        priceArr = mock.map(o=>o.c);
        volArr   = mock.map(o=>o.v);
        updateCard(mock[mock.length-1]);
        drawCharts(mock);
      }
    }

    /* --------- æ›´æ–°å¡ç‰‡ --------- */
    function updateCard(last){
      const prev = priceArr[priceArr.length-2];
      const chg  = last.c - prev;
      const chgP = (chg/prev*100).toFixed(2);
      document.getElementById('price').textContent = last.c.toFixed(2);
      document.getElementById('change').textContent = `${chg>0?'+':''}${chg.toFixed(2)} (${chgP}%)`;
      document.getElementById('change').style.color = chg>0?'#e53e3e':'#4caf50';

      const ma5 = SMA(priceArr,5), ma10 = SMA(priceArr,10), ma20 = SMA(priceArr,20);
      const rsi = RSI(priceArr,14);
      const atr = ATR(priceArr,14);
      const vol = volArr.slice(-1)[0];
      const volat = (ATR(priceArr,14)/last.c*100).toFixed(2);

      document.getElementById('ma5').textContent  = ma5[ma5.length-1]?.toFixed(2) ?? '--';
      document.getElementById('ma10').textContent = ma10[ma10.length-1]?.toFixed(2) ?? '--';
      document.getElementById('ma20').textContent = ma20[ma20.length-1]?.toFixed(2) ?? '--';
      document.getElementById('rsi').textContent  = rsi[rsi.length-1]?.toFixed(2) ?? '--';
      document.getElementById('atr').textContent  = atr[atr.length-1]?.toFixed(2) ?? '--';
      document.getElementById('vol').textContent  = (vol/1e6).toFixed(1)+'M';
      document.getElementById('volat').textContent= volat+'%';

      // Doji & MTM ä¿¡å·
      const doji = Math.abs(last.o - last.c) / (last.h - last.l) < 0.1 ? 'åå­—æ˜Ÿ' : 'æ— ';
      const mtm  = priceArr[priceArr.length-1] - priceArr[priceArr.length-11];
      document.getElementById('doji').textContent = doji;
      document.getElementById('mtm').textContent  = mtm.toFixed(2);
    }

    /* --------- ECharts ç”»å›¾ --------- */
    function drawCharts(ohlcv){
      const dates = ohlcv.map(d=>d.t);
      const ohlc    = ohlcv.map(d=>[d.o,d.c,d.l,d.h]);
      const vols    = ohlcv.map(d=>d.v);
      const indSel  = Array.from(document.getElementById('ind').selectedOptions).map(o=>o.value);

      // 1. ä¸»å›¾ï¼šKçº¿ + MA + å¸ƒæ— + RSI + MACD + Dojiæ•£å°„
      const mainOption = {
        animation: false,
        legend: {data:['Kçº¿','MA5','MA10','MA20','RSI','MACD','Doji','UB','LB'],inactiveColor:'#777',textStyle:{color:'#333'}},
        tooltip: {trigger: 'axis',axisPointer: {type: 'cross'},borderWidth:1,borderColor:'#ccc',padding:10,textStyle:{color:'#333'}},
        axisPointer: {link:[{xAxisIndex:'all'}],label:{backgroundColor:'#777'}},
        grid: [{left:'10%',right:'8%',top:'10%',height:'60%'}],
        xAxis: [{type:'category',data:dates,scale:true,boundaryGap:false,axisLine:{onZero:false},splitLine:{show:false},min:'dataMin',max:'dataMax'}],
        yAxis: [{scale:true,splitArea:{show:true}}],
        dataZoom: [{type:'inside',xAxisIndex:[0],start:50,end:100}],
        series: [
          {name:'Kçº¿',type:'candlestick',data:ohlc,itemStyle:{color:'#ef232a',color0:'#14b143',borderColor:'#ef232a',borderColor0:'#14b143'}},
          {name:'RSI',type:'line',data:RSI(priceArr,14),lineStyle:{width:1.5,color:'#ff9800'},symbol:'none',yAxisIndex:0},
          {name:'MACD',type:'line',data:MACD(priceArr).macd,lineStyle:{width:1.5,color:'#9c27b0'},symbol:'none',yAxisIndex:0}
        ]
      };
      if(indSel.includes('MA')){
        const ma5 = SMA(priceArr,5), ma10 = SMA(priceArr,10), ma20 = SMA(priceArr,20);
        mainOption.series.push(
          {name:'MA5',type:'line',data:ma5,lineStyle:{width:1.5,color:'#f59331'},symbol:'none'},
          {name:'MA10',type:'line',data:ma10,lineStyle:{width:1.5,color:'#4ecdc4'},symbol:'none'},
          {name:'MA20',type:'line',data:ma20,lineStyle:{width:1.5,color:'#45b7d1'},symbol:'none'}
        );
      }
      if(indSel.includes('BB')){
        const bb = BB(priceArr,20);
        mainOption.series.push(
          {name:'UB',type:'line',data:bb.ub,lineStyle:{width:1,color:'#ffa726',type:'dashed'},symbol:'none'},
          {name:'LB',type:'line',data:bb.lb,lineStyle:{width:1,color:'#ffa726',type:'dashed'},symbol:'none'}
        );
      }
      // Doji æ•£å°„
      const dojiData = ohlcv.map((d,i)=>(Math.abs(d.o-d.c)/(d.h-d.l)<0.1?[i,d.h]:null)).filter(v=>v);
      if(dojiData.length) mainOption.series.push({name:'Doji',type:'scatter',symbol:'diamond',symbolSize:8,itemStyle:{color:'#ff9800'},data:dojiData});

      if(!mainChart) mainChart = echarts.init(document.getElementById('mainChart'));
      mainChart.setOption(mainOption);

      // 2. å‰¯å›¾ï¼šç‹¬ç«‹æˆäº¤é‡ï¼ˆé¢œè‰²éšæ¶¨è·Œï¼‰
      const volOption = {
        animation: false,
        grid: [{left:'10%',right:'8%',top:'10%',height:'70%'}],
        xAxis: [{type:'category',data:dates,scale:true,boundaryGap:false,axisLine:{onZero:false},splitLine:{show:false},axisLabel:{show:false}}],
        yAxis: [{type:'value',splitNumber:2,axisLabel:{show:true,formatter:v=>(v/1e6)+'M'},axisLine:{show:false},axisTick:{show:false},splitLine:{show:false}}],
        series: [{
          name:'Volume',type:'bar',data:vols.map((v,i)=>({value:v,itemStyle:{color:ohlcv[i].c>ohlcv[i].o?'#ef232a':'#14b143'}})),
          barWidth:'60%'
        }]
      };
      if(!volChart) volChart = echarts.init(document.getElementById('volChart'));
      volChart.setOption(volOption);

      // è”åŠ¨ç¼©æ”¾
      mainChart.on('dataZoom', function (params) {
        volChart.dispatchAction({type: 'dataZoom',start: params.start,end: params.end});
      });
      volChart.on('dataZoom', function (params) {
        mainChart.dispatchAction({type: 'dataZoom',start: params.start,end: params.end});
      });
    }

    /* --------- æŠ€æœ¯æŒ‡æ ‡ --------- */
    function SMA(arr, n){
      const out = []; let sum = 0;
      for(let i = 0; i < arr.length; i++){ sum += arr[i]; if(i >= n) sum -= arr[i - n]; out[i] = i >= n - 1 ? sum / n : null; }
      return out;
    }
    function BB(arr, n){
      const ma = SMA(arr, n), out = {ub: [], lb: []};
      for(let i = n - 1; i < arr.length; i++){
        const std = Math.sqrt(arr.slice(i - n + 1, i + 1).reduce((s, v) => s + (v - ma[i]) ** 2, 0) / n);
        out.ub[i] = ma[i] + 2 * std; out.lb[i] = ma[i] - 2 * std;
      }
      return out;
    }
    function RSI(arr, n = 14){
      const rsi = []; let up = 0, down = 0;
      for(let i = 1; i <= n; i++){ const d = arr[i] - arr[i - 1]; up += Math.max(d, 0); down += Math.max(-d, 0); }
      let avgUp = up / n, avgDown = down / n;
      for(let i = n; i < arr.length; i++){
        const d = arr[i] - arr[i - 1];
        avgUp = (avgUp * (n - 1) + Math.max(d, 0)) / n;
        avgDown = (avgDown * (n - 1) + Math.max(-d, 0)) / n;
        const rs = avgUp / (avgDown || 1);
        rsi[i] = 100 - 100 / (1 + rs);
      }
      return rsi;
    }
    function MACD(arr, fast = 12, slow = 26, signal = 9){
      const ema12 = EMA(arr, fast), ema26 = EMA(arr, slow);
      const macd = [];
      for(let i = slow - 1; i < arr.length; i++) macd[i] = (ema12[i] || 0) - (ema26[i] || 0);
      const sig = EMA(macd.filter(v => v != null), signal);
      const signalLine = [];
      for(let i = slow + signal - 2; i < arr.length; i++) signalLine[i] = sig[i - slow - signal + 2 + signal - 1] || 0;
      return {macd, signal: signalLine};
    }
    function EMA(arr, n){
      const k = 2 / (n + 1), out = []; let ema = arr[0];
      for(let i = 0; i < arr.length; i++){ ema = arr[i] * k + ema * (1 - k); out[i] = ema; }
      return out;
    }

    /* --------- åŠŸèƒ½ --------- */
    function backtest(){
      if(!priceArr.length){ print('âŒ è¯·å…ˆæŸ¥è¯¢æ•°æ®'); return; }
      const ma5 = SMA(priceArr,5), ma20 = SMA(priceArr,20);
      let pos = 0, cash = 10000, hold = 0, trades = 0;
      for(let i = 20; i < priceArr.length; i++){
        const price = priceArr[i];
        if(ma5[i] > ma20[i] && pos <= 0){
          hold = Math.floor(cash / price);
          cash -= hold * price; pos = 1; trades++;
          print(`ğŸ“ˆ é‡‘å‰ä¹°å…¥ @ ${price.toFixed(2)} è‚¡æ•° ${hold}`);
        }else if(ma5[i] < ma20[i] && pos > 0){
          cash += hold * price;
          print(`ğŸ“‰ æ­»å‰å–å‡º @ ${price.toFixed(2)} è‚¡æ•° ${hold}`);
          pos = 0; hold = 0;
        }
      }
      const final = cash + (hold * priceArr[priceArr.length - 1]);
      print(`\nğŸ§¾ äº¤æ˜“ ${trades} æ¬¡ï¼Œæœ€ç»ˆå‡€å€¼ ${final.toFixed(2)}ï¼Œæ”¶ç›Šç‡ ${((final/10000-1)*100).toFixed(2)}%`);
    }

    function aiAnalysis(){
      print('ğŸ¤– å½“å‰ç­–ç•¥ä¸º MA é‡‘å‰æ­»å‰ï¼Œå»ºè®®åœ¨éœ‡è¡å¸‚åŠ å…¥ RSI è¿‡æ»¤ï¼Œå‡å°‘å‡ä¿¡å·ã€‚');
    }

    /* --------- å‡æ•°æ® fallback --------- */
    function genMockOHLCV(len){
      const out = []; let base = 150;
      for(let i = 0; i < len; i++){
        base += (Math.random() - 0.49) * 2;
        const c = Number(base.toFixed(2));
        const o = c + (Math.random() - 0.5) * 1;
        const h = c + Math.random() * 1;
        const l = c - Math.random() * 1;
        const v = Math.floor(Math.random() * 1e7);
        out.push({o, h, l, c, v, t: i});
      }
      return out;
    }

    /* --------- åˆå§‹åŠ è½½ --------- */
    fetchData();
  </script>
</body>
</html>
