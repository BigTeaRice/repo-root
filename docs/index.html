<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å®æ—¶è¡Œæƒ… + å…¨å¥—æŠ€æœ¯æŒ‡æ ‡</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
:root{--bg:#f4f6fa;--card:#fff;--text:#333;--accent:#2962ff}
@media (prefers-color-scheme: dark){
 :root{--bg:#121212;--card:#1e1e1e;--text:#eee;--accent:#82b1ff}
}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:20px auto;padding:10px}
.card{background:var(--card);border-radius:12px;padding:15px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.15)}
h1{text-align:center}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select{flex:1;padding:10px;border:1px solid #bbb;border-radius:6px;background:var(--card);color:var(--text)}
button{padding:10px 16px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer}
#chart{width:100%;height:460px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax 130px,1fr));gap:10px;font-size:.9rem}
.item{padding:8px;border-radius:6px;background:var(--bg)}
.item span:first-child{opacity:.7}
.item span:last-child{font-weight:600}
#time{font-size:.8rem;opacity:.6;text-align:right;margin-top:8px}
.btn-row{margin-top:10px;display:flex;gap:10px}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ“ˆ å®æ—¶è¡Œæƒ… + å…¨å¥—æŠ€æœ¯æŒ‡æ ‡</h1>
  <div class="card row">
    <select id="market">
      <option value="us">ç¾è‚¡ (15min)</option>
      <option value="hk">æ¸¯è‚¡ (15min)</option>
      <option value="sz">æ·±åœ³ (æ—¥K)</option>
      <option value="sh">ä¸Šæµ· (æ—¥K)</option>
    </select>
    <input id="symbol" placeholder="ä»£ç  e.g. AAPL, 0700, 000001" value="AAPL">
    <select id="range">
      <option value="1d">1 æ—¥</option>
      <option value="5d">5 æ—¥</option>
      <option value="1mo">1 æœˆ</option>
      <option value="3mo">3 æœˆ</option>
      <option value="6mo">6 æœˆ</option>
      <option value="1y">1 å¹´</option>
      <option value="2y">2 å¹´</option>
      <option value="5y">5 å¹´</option>
      <option value="10y">10 å¹´</option>
    </select>
    <button onclick="fetchData()">æŸ¥è¯¢</button>
  </div>

  <div class="card">
    <div class="grid" id="info"></div>
    <div id="time"></div>
  </div>

  <div class="card">
    <div id="chart"></div>
  </div>

  <div class="card btn-row">
    <button onclick="location.href='/'">å›ä¸»é </button>
    <button onclick="aiAnalysis()">äººå·¥æ™ºèƒ½åˆ†æ</button>
  </div>
</div>

<script>
const $ = q => document.querySelector(q);
const market = $('#market'), symbol = $('#symbol'), range = $('#range'), info = $('#info'), myChart = echarts.init($('#chart'));

// 30 ç§’è‡ªå‹•åˆ·æ–°
setInterval(() => {
  if (symbol.value.trim()) fetchData();
}, 30000);

// ============= æ•°æ®æº =============
// 1) Yahoo Finance 15min Kï¼ˆç¾è‚¡ã€æ¸¯è‚¡ï¼‰â†’ ç”¨ GitHub Pages åç«¯ JSON
async function fetchYF(sym, exch) {
  const file = sym.toLowerCase().replace('.', '_') + '.json';
  const url = `data/${file}?t=${Date.now()}`;
  const json = await fetch(url).then(r => r.json()).catch(() => null);
  if (!json || !json.data) return null;
  // æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤
  const now = new Date();
  const cut = new Date(now - parseRange(range.value));
  return json.data.filter(it => new Date(it.datetime) >= cut);
}

// 2) AkShare æ—¥ Kï¼ˆæ·±åœ³ã€ä¸Šæµ·ï¼‰â†’ ç”¨ GitHub Pages åç«¯ JSON
async function fetchAk(sym) {
  const file = sym.toLowerCase().replace('.', '_') + '.json';
  const url = `data/${file}?t=${Date.now()}`;
  const json = await fetch(url).then(r => r.json()).catch(() => null);
  if (!json || !json.data) return null;
  // æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤
  const now = new Date();
  const cut = new Date(now - parseRange(range.value));
  return json.data.filter(it => new Date(it.datetime) >= cut);
}

// è§£ææ—¶é—´èŒƒå›´
function parseRange(val) {
  const map = { '1d': 1, '5d': 5, '1mo': 30, '3mo': 90, '6mo': 180, '1y': 365, '2y': 730, '5y': 1825, '10y': 3650 };
  return (map[val] || 30) * 24 * 60 * 60 * 1000;
}

// ============= æŠ€è¡“æŒ‡æ¨™ï¼ˆå‰ç«¯å³æ™‚è¨ˆç®—ï¼‰ =============
function calcIndicators(bars) {
  const n = bars.length;
  const c = bars.map(x => x.c);
  const h = bars.map(x => x.h);
  const l = bars.map(x => x.l);
  const o = bars.map(x => x.o);

  // 1) MA
  const ma5 = [], ma10 = [], ma20 = [];
  for (let i = 0; i < n; i++) {
    ma5.push(i >= 4 ? avg(c.slice(i - 4, i + 1)) : null);
    ma10.push(i >= 9 ? avg(c.slice(i - 9, i + 1)) : null);
    ma20.push(i >= 19 ? avg(c.slice(i - 19, i + 1)) : null);
  }

  // 2) RSI(14)
  const rsi = [null];
  for (let i = 1; i < n; i++) {
    const delta = c[i] - c[i - 1];
    const gain = Math.max(delta, 0);
    const loss = Math.max(-delta, 0);
    if (i === 1) { rsi.push(50); continue; }
    const avgGain = (rsi[i - 1] / 100 * (i - 1) + gain) / i;
    const avgLoss = ((100 - rsi[i - 1]) / 100 * (i - 1) + loss) / i;
    const rs = avgGain / avgLoss;
    rsi.push(100 - (100 / (1 + rs)));
  }

  // 3) ATR(14)
  const atr = [null];
  for (let i = 1; i < n; i++) {
    const tr = Math.max(h[i] - l[i], Math.abs(h[i] - c[i - 1]), Math.abs(l[i] - c[i - 1]));
    atr.push(i === 1 ? tr : (atr[i - 1] * 13 + tr) / 14);
  }

  // 4) MTM(12)
  const mtm = [];
  for (let i = 0; i < n; i++) mtm.push(i >= 11 ? c[i] / c[i - 11] - 1 : null);

  // 5) Doji æª¢æ¸¬
  const doji = bars.map((it, i) => {
    const body = Math.abs(it.c - it.o);
    const hl = it.h - it.l;
    return hl > 0 && body / hl < 0.001;
  });

  return { ma5, ma10, ma20, rsi, atr, mtm, doji };
}

function avg(arr) {
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}

// ============= æ¸²æŸ“ =============
async function fetchData() {
  const sym = symbol.value.trim().toUpperCase();
  const mkt = market.value;
  if (!sym) return;
  const bars = (mkt === 'us' || mkt === 'hk') ? await fetchYF(sym, mkt === 'us' ? 'US' : 'HK') : await fetchAk(sym);
  if (!bars || bars.length === 0) {
    info.innerHTML = '<div class="item">æŸ¥ç„¡è³‡æ–™</div>';
    return;
  }
  const ind = calcIndicators(bars);
  renderInfo(bars, ind);
  renderChart(bars, ind);
  $('#time').innerText = 'æ›´æ–°: ' + new Date().toLocaleString();
}

function renderInfo(bars, ind) {
  const last = bars[bars.length - 1];
  const rsi = ind.rsi[ind.rsi.length - 1];
  const atr = ind.atr[ind.atr.length - 1];
  const mtm = ind.mtm[ind.mtm.length - 1];
  const isDoji = ind.doji[ind.doji.length - 1];
  info.innerHTML = `
    <div class="item"><span>æœ€æ–°åƒ¹</span><span>${last.c.toFixed(2)}</span></div>
    <div class="item"><span>æ¼²è·Œå¹…</span><span style="color:${last.c >= last.o ? '#0f0' : '#f00'}">${((last.c - last.o) / last.o * 100).toFixed(2)}%</span></div>
    <div class="item"><span>RSI(14)</span><span>${rsi ? rsi.toFixed(2) : '--'}</span></div>
    <div class="item"><span>ATR(14)</span><span>${atr ? atr.toFixed(2) : '--'}</span></div>
    <div class="item"><span>MTM(12)</span><span>${mtm ? (mtm * 100).toFixed(2) + '%' : '--'}</span></div>
    <div class="item"><span>åå­—æ˜Ÿ</span><span>${isDoji ? 'âœ…' : 'âŒ'}</span></div>
    <div class="item"><span>MA5</span><span>${ind.ma5[ind.ma5.length - 1]?.toFixed(2) || '--'}</span></div>
    <div class="item"><span>MA10</span><span>${ind.ma10[ind.ma10.length - 1]?.toFixed(2) || '--'}</span></div>
    <div class="item"><span>MA20</span><span>${ind.ma20[ind.ma20.length - 1]?.toFixed(2) || '--'}</span></div>
  `;
}

function renderChart(bars, ind) {
  const times = bars.map(it => it.t.toLocaleTimeString());
  const c = bars.map(it => it.c);
  const ma5 = ind.ma5;
  const ma10 = ind.ma10;
  const ma20 = ind.ma20;
  const vol = bars.map(it => it.v);

  myChart.setOption({
    title: { text: `${symbol.value}  Kç·šèˆ‡æŠ€è¡“æŒ‡æ¨™`, left: 'center' },
    tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
    legend: { data: ['K', 'MA5', 'MA10', 'MA20'], top: 25 },
    grid: [{ left: '10%', right: '8%', top: '15%', height: '55%' }, { left: '10%', right: '8%', top: '75%', height: '12%' }],
    xAxis: [{ type: 'category', data: times, scale: true }, { type: 'category', gridIndex: 1, data: times, scale: true }],
    yAxis: [{ type: 'value', scale: true }, { type: 'value', scale: true, gridIndex: 1 }],
    dataZoom: [{ type: 'inside', xAxisIndex: [0, 1], start: 70, end: 100 }, { type: 'slider', xAxisIndex: [0, 1], start: 70, end: 100, top: '90%' }],
    series: [
      { name: 'K', type: 'candlestick', data: bars.map(it => [it.o, it.c, it.l, it.h]), itemStyle: { color: '#ef232a', color0: '#14b143' } },
      { name: 'MA5', type: 'line', data: ma5, smooth: true, lineStyle: { width: 1.5, color: '#c23531' }, symbol: 'none' },
      { name: 'MA10', type: 'line', data: ma10, smooth: true, lineStyle: { width: 1.5, color: '#ff9800' }, symbol: 'none' },
      { name: 'MA20', type: 'line', data: ma20, smooth: true, lineStyle: { width: 1.5, color: '#2c3e50' }, symbol: 'none' },
      { name: 'Volume', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: vol, itemStyle: { color: vol.map((_, i) => bars[i].c >= bars[i].o ? '#ef232a' : '#14b143') } }
    ]
  });
}

// ============= æ–°å¢æŒ‰é’®åŠŸèƒ½ =============
function aiAnalysis() {
  alert('ğŸ¤– äººå·¥æ™ºèƒ½åˆ†æåŠŸèƒ½å³å°†ä¸Šçº¿ï¼\n\nâœ… æƒ…æ„Ÿåˆ†æ\nâœ… è¶‹åŠ¿é¢„æµ‹\nâœ… é£é™©è¯„åˆ†\n\næ•¬è¯·æœŸå¾…ï¼');
}

// ============= åˆå§‹åŒ– =============
fetchData();
</script>
</body>
</html>
