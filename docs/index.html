<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è‚¡ç¥¨åˆ†æå·¥å…· - å‰åç«¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ä½¿ç”¨ Tailwind å¿«é€Ÿå»ºç«‹éŸ¿æ‡‰å¼ UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    /* è‡ªè¨‚é¡è‰²è®Šé‡ */
    :root {
      --primary: #111;
      --accent: #f59331;
      --bg: #f7f7f7;
      --card: #fff;
    }
    /* ç¢ºä¿ ECharts å®¹å™¨æœ‰å°ºå¯¸ */
    #mainChart, #volChart {
      background: var(--card);
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
      margin: 0 16px 16px;
      min-height: 200px; /* ç¢ºä¿æœ€å°é«˜åº¦ */
    }
    /* è‡ªè¨‚æ»¾å‹•æ¢å’Œæ—¥èªŒæ¡†æ¨£å¼ */
    #log {
      background: #eee;
      margin: 16px;
      border-radius: 6px;
      padding: 12px;
      font-size: 13px;
      white-space: pre-wrap;
      height: 120px;
      overflow: auto;
      border: 1px solid #ddd;
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
          },
        },
      }
    }
  </script>
</head>
<body class="bg-gray-100 font-sans p-0 m-0 pb-16">
  <header class="bg-gray-800 text-white p-4 text-lg font-bold sticky top-0 z-10">è‚¡ç¥¨åˆ†æå·¥å…· - å‰åç«¯ (Pages éœæ…‹)</header>

  <div class="flex flex-wrap gap-2 p-4 bg-white border-b border-gray-200 items-center">
    <input id="symbol" type="text" placeholder="AAPL / 0700.HK" value="AAPL" class="p-2 border border-gray-300 rounded-md text-sm flex-grow min-w-[100px]">
    <select id="range" class="p-2 border border-gray-300 rounded-md text-sm">
      <option value="1d">1 å¤©</option>
      <option value="5d">5 å¤©</option>
      <option value="30d" selected>30 å¤©</option>
      <option value="90d">90 å¤©</option>
      <option value="180d">180 å¤©</option>
      <option value="1y">1 å¹´</option>
    </select>
    <select id="ind" multiple title="Ctrl+å¤šé€‰" class="p-2 border border-gray-300 rounded-md text-sm max-w-[180px]">
      <option value="MA" selected>ç§»åŠ¨å¹³å‡ (MA)</option>
      <option value="BB">å¸ƒæ—å¸¦ (Bollinger)</option>
      <option value="RSI">ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡ (RSI)</option>
      <option value="MACD">MACD</option>
    </select>
    <button onclick="fetchData()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm transition duration-150">æŸ¥è¯¢</button>
  </div>

  <div class="flex flex-wrap p-4 gap-4">
    <!-- å·¦å´å³æ™‚å¡ç‰‡ -->
    <div class="bg-white rounded-lg shadow-md p-4 flex-shrink-0 w-full sm:w-64">
      <div class="text-3xl font-bold text-orange-500" id="price">--</div>
      <div class="text-lg" id="change">--</div>
      <hr class="my-3 border-gray-200">
      <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700">
        <div><span>MA5</span><span id="ma5" class="float-right font-medium">--</span></div>
        <div><span>MA10</span><span id="ma10" class="float-right font-medium">--</span></div>
        <div><span>MA20</span><span id="ma20" class="float-right font-medium">--</span></div>
        <div><span>RSI(14)</span><span id="rsi" class="float-right font-medium">--</span></div>
        <div><span>ATR(14)</span><span id="atr" class="float-right font-medium">--</span></div>
        <div><span>æˆäº¤é‡</span><span id="vol" class="float-right font-medium">--</span></div>
        <div><span>æ³¢å‹•ç‡</span><span id="volat" class="float-right font-medium">--</span></div>
        <div><span>Dojiä¿¡è™Ÿ</span><span id="doji" class="float-right font-medium">--</span></div>
        <div><span>MTMä¿¡è™Ÿ</span><span id="mtm" class="float-right font-medium">--</span></div>
      </div>
    </div>

    <!-- å³å´ä¸»åœ–+å‰¯åœ– -->
    <div class="bg-white rounded-lg shadow-md flex-grow w-full min-w-[300px] p-4">
      <div id="mainChart" style="height:360px;" class="mb-4"></div>
      <div id="volChart" style="height:180px;"></div>
    </div>
  </div>

  <div id="log" class="text-gray-700"></div>

  <!-- åº•éƒ¨å›ºå®šå°èˆª -->
  <footer class="fixed bottom-0 left-0 right-0 bg-gray-800 flex justify-center gap-4 p-3 shadow-lg z-10">
    <a href="./" class="text-white text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md transition duration-150">è¿”å›ä¸»é </a>
    <!-- å‡è¨­é€™äº›æ–‡ä»¶ä¹Ÿå­˜åœ¨æˆ–ä½¿ç”¨ç›¸åŒ index.html æ¨¡æ“¬è·¯ç”± -->
    <a href="./backtest.html" onclick="print('å›æµ‹é¡µé¢æ¨¡æ‹Ÿ'); return false;" class="text-white text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md transition duration-150">å›æµ‹é¡µé¢</a>
    <a href="./ai.html" onclick="aiAnalysis(); return false;" class="text-white text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md transition duration-150">AI åˆ†æ</a>
  </footer>

  <script>
    /* --------- å·¥å…·å‡½æ•¸ --------- */
    const logBox = document.getElementById('log');
    function print(...args){ 
      logBox.textContent += args.join(' ') + '\n'; 
      logBox.scrollTop = logBox.scrollHeight; 
    }
    
    // å…¨åŸŸè®Šæ•¸
    let priceArr = [], volArr = [], ohlcvData = [], mainChart, volChart;

    /* --------- è³‡æ–™è™•ç†èˆ‡ç²å– --------- */
    // Helper: ç²å–å¾Œç«¯ API URL
    function getApiUrl(sym, range) {
        // åˆ¤æ–·æ˜¯å¦åœ¨æœ¬åœ°æˆ–Codespacesä¸Šé‹è¡Œ (ç”¨æ–¼æ¸¬è©¦ app.py)
        const isLocal = location.hostname === "localhost" || location.port === "5000";
        if (isLocal) {
            return `${location.protocol}//${location.hostname}:5000/api/kline?sym=${sym}&range=${range}`;
        }
        
        // å‡è¨­æ‚¨å·²éƒ¨ç½² FastAPI åˆ°ç¨ç«‹ä¼ºæœå™¨ï¼Œæ‚¨éœ€è¦æ›¿æ›ä»¥ä¸‹ URL
        // é€™è£¡æš«æ™‚æŒ‡å‘ä¸€å€‹ä¸æœƒæˆåŠŸçš„ URLï¼Œä»¥è§¸ç™¼å‡è³‡æ–™ fallback
        // å¦‚æœæ‚¨çš„ Fast API éƒ¨ç½²åœ¨ä¸€å€‹å…¬å…± URL (ä¾‹å¦‚ Heroku, Render)ï¼Œè«‹åœ¨é€™è£¡æ›¿æ›
        return `https://your-deployed-fastapi.com/api/kline?sym=${sym}&range=${range}`; 
    }

    // æ ¸å¿ƒæ‹‰å–æ•¸æ“šå‡½æ•¸
    async function fetchData(){
      const sym = document.getElementById('symbol').value.trim();
      const range = document.getElementById('range').value;
      const apiUrl = getApiUrl(sym, range);
      
      print(`æ‹‰å– ${sym} ${range} è¡Œæƒ…... API: ${apiUrl}`);
      
      try{
        const res = await fetch(apiUrl);
        
        if(!res.ok) throw new Error(`API éŒ¯èª¤: ${res.statusText}`);
        
        const raw = await res.json();
        if (raw.length === 0) throw new Error('API è¿”å›ç©ºæ•¸æ“š');

        ohlcvData = calculateIndicators(raw); // è¨ˆç®—æŒ‡æ¨™
        priceArr = ohlcvData.map(d=>d.c);
        volArr   = ohlcvData.map(d=>d.v);

        updateCard(ohlcvData[ohlcvData.length-1]);
        drawCharts(ohlcvData);
        print(`âœ… å¾Œç«¯è¿”å› ${raw.length} æ¢è¨˜éŒ„ä¸¦è¨ˆç®—æŒ‡æ¨™å®Œæˆ`);

      }catch(e){
        print(`âŒ å¾Œç«¯å‘¼å«å¤±æ•—æˆ–ç„¡æ•ˆ (${e.message})ï¼Œä½¿ç”¨å‡æ•¸æ“šæ¼”ç¤ºã€‚`);
        const mock = genMockOHLCV(200);
        ohlcvData = calculateIndicators(mock); // å°å‡æ•¸æ“šä¹Ÿè¨ˆç®—æŒ‡æ¨™
        priceArr = ohlcvData.map(d=>d.c);
        volArr   = ohlcvData.map(d=>d.v);
        updateCard(ohlcvData[ohlcvData.length-1]);
        drawCharts(ohlcvData);
      }
    }

    // å°‡æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™è¨ˆç®—é›†ä¸­åœ¨æ­¤è™•ï¼Œé¿å… app.py å’Œ index.html é‚è¼¯é‡è¤‡
    function calculateIndicators(data){
        const closePrices = data.map(d => d.c);
        const ohlcv = data;

        // 1. MA
        const ma5 = SMA(closePrices, 5);
        const ma10 = SMA(closePrices, 10);
        const ma20 = SMA(closePrices, 20);

        // 2. BB (éœ€è¦ MA20)
        const bb = BB(closePrices, 20);

        // 3. RSI
        const rsi = RSI(closePrices, 14);

        // 4. MACD
        const macd = MACD(closePrices);

        // 5. ATR (éœ€è¦ OHLC)
        const atr = ATR(ohlcv, 14);
        
        // æ•´åˆçµæœ
        return ohlcv.map((d, i) => ({
            ...d,
            ma5: ma5[i] ? ma5[i].toFixed(2) : null,
            ma10: ma10[i] ? ma10[i].toFixed(2) : null,
            ma20: ma20[i] ? ma20[i].toFixed(2) : null,
            ub: bb.ub[i] ? bb.ub[i].toFixed(2) : null,
            lb: bb.lb[i] ? bb.lb[i].toFixed(2) : null,
            rsi: rsi[i] ? rsi[i].toFixed(2) : null,
            atr: atr[i] ? atr[i].toFixed(2) : null,
            macd: macd.macd[i] ? macd.macd[i].toFixed(2) : null,
            signal: macd.signal[i] ? macd.signal[i].toFixed(2) : null,
        })).filter(d => d.ma20 !== null); // ç§»é™¤æœªè¨ˆç®—å‡º MA20 çš„å‰æœŸæ•¸æ“š
    }

    /* --------- æ›´æ–°å¡ç‰‡ --------- */
    function updateCard(last){
      if(!priceArr.length || priceArr.length < 2) return;
      
      const prev = priceArr[priceArr.length-2];
      const chg  = last.c - prev;
      const chgP = (chg/prev*100).toFixed(2);
      
      document.getElementById('price').textContent = last.c.toFixed(2);
      document.getElementById('change').textContent = `${chg>0?'+':''}${chg.toFixed(2)} (${chgP}%)`;
      document.getElementById('change').className = `text-lg ${chg>0?'text-red-600':'text-green-600'}`;

      document.getElementById('ma5').textContent  = last.ma5 ?? '--';
      document.getElementById('ma10').textContent = last.ma10 ?? '--';
      document.getElementById('ma20').textContent = last.ma20 ?? '--';
      document.getElementById('rsi').textContent  = last.rsi ?? '--';
      document.getElementById('atr').textContent  = last.atr ?? '--';
      document.getElementById('vol').textContent  = (last.v/1e6).toFixed(1)+'M';
      
      const volat = (last.atr !== '--' && last.c > 0 ? (parseFloat(last.atr) / last.c * 100).toFixed(2) : '--');
      document.getElementById('volat').textContent= volat + (volat !== '--' ? '%' : '');

      // Doji & MTM ä¿¡å·
      const doji = last.doji ? 'âœ… åå­—æ˜Ÿ' : 'ç„¡';
      const mtm  = priceArr.length > 10 ? (priceArr[priceArr.length-1] - priceArr[priceArr.length-11]) : 0;
      document.getElementById('doji').textContent = doji;
      document.getElementById('mtm').textContent  = mtm.toFixed(2);
    }

    /* --------- ECharts ç•«åœ– --------- */
    function drawCharts(ohlcv){
      const dates = ohlcv.map(d=>d.t);
      // Echarts Kç·šæ•¸æ“šæ ¼å¼: [open, close, lowest, highest]
      const ohlc    = ohlcv.map(d=>[d.o,d.c,d.l,d.h]);
      const vols    = ohlcv.map(d=>d.v);
      const indSel  = Array.from(document.getElementById('ind').selectedOptions).map(o=>o.value);
      
      // 1. ä¸»åœ–ï¼šKç·š + MA + å¸ƒæ—
      const mainSeries = [
        {name:'Kç·š',type:'candlestick',data:ohlc,itemStyle:{color:'#ef232a',color0:'#14b143',borderColor:'#ef232a',borderColor0:'#14b143'}}
      ];
      
      if(indSel.includes('MA')){
        mainSeries.push(
          {name:'MA5',type:'line',data:ohlcv.map(d=>d.ma5??null),lineStyle:{width:1.5,color:'#f59331'},symbol:'none'},
          {name:'MA10',type:'line',data:ohlcv.map(d=>d.ma10??null),lineStyle:{width:1.5,color:'#4ecdc4'},symbol:'none'},
          {name:'MA20',type:'line',data:ohlcv.map(d=>d.ma20??null),lineStyle:{width:1.5,color:'#45b7d1'},symbol:'none'}
        );
      }
      if(indSel.includes('BB')){
        mainSeries.push(
          {name:'UB',type:'line',data:ohlcv.map(d=>d.ub??null),lineStyle:{width:1,color:'#ffa726',type:'dashed'},symbol:'none'},
          {name:'LB',type:'line',data:ohlcv.map(d=>d.lb??null),lineStyle:{width:1,color:'#ffa726',type:'dashed'},symbol:'none'}
        );
      }
      if(indSel.includes('RSI')){
        mainSeries.push(
          {name:'RSI',type:'line',data:ohlcv.map(d=>d.rsi??null),lineStyle:{width:1.5,color:'#ff00ff'},symbol:'none'}
        );
      }
      if(indSel.includes('MACD')){
        mainSeries.push(
          {name:'MACD',type:'line',data:ohlcv.map(d=>d.macd??null),lineStyle:{width:1.5,color:'#9c27b0'},symbol:'none'},
          {name:'Signal',type:'line',data:ohlcv.map(d=>d.signal??null),lineStyle:{width:1.5,color:'#00ffff'},symbol:'none'}
        );
      }
      
      // Doji æ•£å°„
      const dojiData = ohlcv.map((d,i)=>(d.doji?[i,d.h]:null)).filter(v=>v);
      if(dojiData.length) mainSeries.push({name:'Doji',type:'scatter',symbol:'diamond',symbolSize:8,itemStyle:{color:'#ff9800'},data:dojiData});


      const mainOption = {
        animation: false,
        legend: {data:mainSeries.map(s=>s.name),inactiveColor:'#777',textStyle:{color:'#333'}},
        tooltip: {trigger: 'axis',axisPointer: {type: 'cross'},borderWidth:1,borderColor:'#ccc',padding:10,textStyle:{color:'#333'}},
        axisPointer: {link:[{xAxisIndex:'all'}],label:{backgroundColor:'#777'}},
        grid: [{left:'10%',right:'8%',top:'10%',height:'60%'}],
        xAxis: [{type:'category',data:dates,scale:true,boundaryGap:false,axisLine:{onZero:false},splitLine:{show:false},min:'dataMin',max:'dataMax'}],
        yAxis: [{scale:true,splitArea:{show:true},position: 'right'}],
        dataZoom: [{type:'inside',xAxisIndex:[0],start:70,end:100}],
        series: mainSeries
      };

      if(!mainChart) mainChart = echarts.init(document.getElementById('mainChart'));
      mainChart.setOption(mainOption);

      // 2. å‰¯åœ–ï¼šç¨ç«‹æˆäº¤é‡ï¼ˆé¡è‰²éš¨æ¼²è·Œï¼‰
      const volOption = {
        animation: false,
        grid: [{left:'10%',right:'8%',top:'10%',height:'70%'}],
        xAxis: [{type:'category',data:dates,scale:true,boundaryGap:false,axisLine:{onZero:false},splitLine:{show:false},axisLabel:{show:false}}],
        yAxis: [{type:'value',splitNumber:2,axisLabel:{show:true,formatter:v=>(v/1e6)+'M'},axisLine:{show:false},axisTick:{show:false},splitLine:{show:false},position: 'right'}],
        series: [{
          name:'Volume',type:'bar',data:vols.map((v,i)=>({value:v,itemStyle:{color:ohlcv[i].c>ohlcv[i].o?'#ef232a':'#14b143'}})),
          barWidth:'60%'
        }]
      };
      if(!volChart) volChart = echarts.init(document.getElementById('volChart'));
      volChart.setOption(volOption);

      // éŸ¿æ‡‰å¼ï¼šç›£è½çª—å£å¤§å°è®ŠåŒ–
      window.onresize = function() {
          mainChart.resize();
          volChart.resize();
      };

      // è¯å‹•ç¸®æ”¾
      mainChart.on('dataZoom', function (params) {
        volChart.dispatchAction({type: 'dataZoom',start: params.start,end: params.end});
      });
      volChart.on('dataZoom', function (params) {
        mainChart.dispatchAction({type: 'dataZoom',start: params.start,end: params.end});
      });
    }

    /* ---------------------------------------------------- */
    /* --------- æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å‡½æ•¸ (ä¿ç•™åŸé‚è¼¯) --------- */
    /* ---------------------------------------------------- */
    // Simple Moving Average (SMA)
    function SMA(arr, n){
      const out = []; let sum = 0;
      for(let i = 0; i < arr.length; i++){ 
        sum += arr[i]; 
        if(i >= n) sum -= arr[i - n]; 
        out[i] = i >= n - 1 ? sum / n : null; 
      }
      return out;
    }
    
    // Bollinger Bands (BB)
    function BB(arr, n){
      const ma = SMA(arr, n), out = {ub: [], lb: []};
      for(let i = n - 1; i < arr.length; i++){
        const slice = arr.slice(i - n + 1, i + 1);
        const mean = ma[i];
        const std = Math.sqrt(slice.reduce((s, v) => s + (v - mean) ** 2, 0) / n);
        out.ub[i] = mean + 2 * std; 
        out.lb[i] = mean - 2 * std;
      }
      return out;
    }
    
    // Relative Strength Index (RSI) - Wilder Smoothing
    function RSI(arr, n = 14){
      const rsi = []; let avgUp = 0, avgDown = 0;
      if (arr.length < n + 1) return [];

      // è¨ˆç®—åˆå§‹ RS
      let up = 0, down = 0;
      for(let i = 1; i <= n; i++){ 
        const d = arr[i] - arr[i - 1]; 
        up += Math.max(d, 0); 
        down += Math.max(-d, 0); 
      }
      avgUp = up / n; 
      avgDown = down / n;
      rsi[n] = 100 - 100 / (1 + avgUp / (avgDown || 1e-10)); // é¿å…é™¤ä»¥é›¶

      // å¾ŒçºŒè¨ˆç®—
      for(let i = n + 1; i < arr.length; i++){
        const d = arr[i] - arr[i - 1];
        const currentUp = Math.max(d, 0);
        const currentDown = Math.max(-d, 0);

        avgUp = (avgUp * (n - 1) + currentUp) / n;
        avgDown = (avgDown * (n - 1) + currentDown) / n;
        
        const rs = avgUp / (avgDown || 1e-10);
        rsi[i] = 100 - 100 / (1 + rs);
      }
      return rsi;
    }
    
    // Exponential Moving Average (EMA)
    function EMA(arr, n){
      const k = 2 / (n + 1), out = []; 
      if (!arr.length) return out;
      
      // ä½¿ç”¨ SMA ä½œç‚ºåˆå§‹å€¼
      let ema = SMA(arr.slice(0, n), n)[n - 1];
      if (ema === null) ema = arr[0]; // å¦‚æœæ•¸æ“šä¸è¶³ n å€‹ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹å€¼
      out[n - 1] = ema;

      for(let i = 0; i < arr.length; i++){ 
          if (i < n) {
              out[i] = null;
          } else {
              // k * Current_Close + (1 - k) * Previous_EMA
              ema = arr[i] * k + ema * (1 - k); 
              out[i] = ema; 
          }
      }
      return out;
    }
    
    // Moving Average Convergence Divergence (MACD)
    function MACD(arr, fast = 12, slow = 26, signal = 9){
      const ema12 = EMA(arr, fast);
      const ema26 = EMA(arr, slow);
      const macd = [];
      
      for(let i = 0; i < arr.length; i++) {
          if (ema12[i] !== null && ema26[i] !== null) {
              macd[i] = ema12[i] - ema26[i];
          } else {
              macd[i] = null;
          }
      }
      
      // è¨ˆç®—ä¿¡è™Ÿç·š (Signal Line)
      // éæ¿¾æ‰ MACD ä¸­çš„ null å€¼
      const filteredMacd = macd.filter(v => v !== null);
      const sig = EMA(filteredMacd, signal);
      
      // å°‡ä¿¡è™Ÿç·šå°é½Šå›åŸå§‹ MACD é™£åˆ—
      const signalLine = new Array(arr.length).fill(null);
      const offset = macd.findIndex(v => v !== null); // æ‰¾åˆ° MACD é–‹å§‹æœ‰å€¼çš„ç´¢å¼•
      
      for(let i = 0; i < sig.length; i++) {
          // ä¿¡è™Ÿç·šå¾ MACD é™£åˆ—æœ‰å€¼çš„ç¬¬ signal å€‹é»é–‹å§‹æœ‰å€¼
          if (sig[i] !== null) {
            signalLine[offset + i] = sig[i];
          }
      }
      
      return {macd, signal: signalLine};
    }
    
    // Average True Range (ATR)
    function ATR(ohlcv, n = 14){
        const trs = [];
        const atr = [];
        
        for (let i = 0; i < ohlcv.length; i++) {
            const h = ohlcv[i].h;
            const l = ohlcv[i].l;
            const cPrev = i > 0 ? ohlcv[i-1].c : ohlcv[0].c;

            // True Range = Max(|High - Low|, |High - PrevClose|, |Low - PrevClose|)
            const tr = Math.max(h - l, Math.abs(h - cPrev), Math.abs(l - cPrev));
            trs.push(tr);
        }

        // ä½¿ç”¨ Wilder's Smoothing for ATR (èˆ‡ RSI ç›¸åŒ)
        let sumTR = 0;
        for (let i = 0; i < n; i++) {
            sumTR += trs[i];
        }
        let avgTR = sumTR / n;
        
        for(let i = 0; i < ohlcv.length; i++){
            if (i < n) {
                atr[i] = null;
            } else if (i === n) {
                atr[i] = avgTR;
            } else {
                // ATR = ((Prev ATR * (n-1)) + Current TR) / n
                avgTR = (avgTR * (n - 1) + trs[i]) / n;
                atr[i] = avgTR;
            }
        }
        return atr;
    }


    /* --------- å‡è³‡æ–™ç”Ÿæˆ (ç”¨æ–¼å¾Œç«¯ä¸å¯ç”¨æ™‚çš„æ¼”ç¤º) --------- */
    function genMockOHLCV(count) {
        const mockData = [];
        let lastClose = 100.0;
        let baseVol = 5000000;
        const today = new Date();

        for (let i = 0; i < count; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() - (count - 1 - i));
            const dateStr = date.toISOString().split('T')[0];

            const change = (Math.random() - 0.5) * 2; // -1 to 1
            const open = lastClose * (1 + change * 0.005);
            const close = open * (1 + change * 0.008);
            
            const high = Math.max(open, close) * (1 + Math.random() * 0.005);
            const low = Math.min(open, close) * (1 - Math.random() * 0.005);
            
            const volume = Math.floor(baseVol * (0.8 + Math.random() * 0.4)); // 80% to 120%
            
            // ç°¡åŒ– Doji åˆ¤æ–·ï¼šOpen â‰ˆ Close (åƒ¹å·®å°æ–¼ 0.1% çš„æŒ¯å¹…)
            const doji = Math.abs(open - close) < (high - low) * 0.1;

            mockData.push({
                t: dateStr,
                o: parseFloat(open.toFixed(2)),
                h: parseFloat(high.toFixed(2)),
                l: parseFloat(low.toFixed(2)),
                c: parseFloat(close.toFixed(2)),
                v: volume,
                doji: doji,
            });
            lastClose = parseFloat(close.toFixed(2));
        }
        return mockData;
    }

    /* --------- åŠŸèƒ½ --------- */
    function backtest(){
      if(!priceArr.length){ print('âŒ è«‹å…ˆæŸ¥è©¢æ•¸æ“š'); return; }
      const ma5 = SMA(priceArr,5), ma20 = SMA(priceArr,20);
      let pos = 0, cash = 10000, hold = 0, trades = 0;
      for(let i = 20; i < priceArr.length; i++){
        const price = priceArr[i];
        if(ma5[i] > ma20[i] && pos <= 0){
          hold = Math.floor(cash / price);
          cash -= hold * price; pos = 1; trades++;
          print(`ğŸ“ˆ é‡‘å‰è²·å…¥ @ ${price.toFixed(2)} è‚¡æ•¸ ${hold}`);
        }else if(ma5[i] < ma20[i] && pos > 0){
          cash += hold * price;
          print(`ğŸ“‰ æ­»å‰è³£å‡º @ ${price.toFixed(2)} è‚¡æ•¸ ${hold}`);
          pos = 0; hold = 0;
        }
      }
      const final = cash + (hold * priceArr[priceArr.length - 1]);
      print(`\n================================`);
      print(`ğŸ§¾ äº¤æ˜“ ${trades} æ¬¡ï¼Œåˆå§‹æ·¨å€¼ 10000.00`);
      print(`æœ€çµ‚æ·¨å€¼ ${final.toFixed(2)}ï¼Œæ”¶ç›Šç‡ ${((final/10000-1)*100).toFixed(2)}%`);
      print(`================================`);
    }

    function aiAnalysis(){
      print('ğŸ¤– åˆ†æï¼šç•¶å‰ç­–ç•¥ç‚º MA é‡‘å‰æ­»å‰ã€‚');
      print('å»ºè­°ï¼šåœ¨éœ‡ç›ªå¸‚å ´ä¸­ï¼Œæ‡‰åŠ å…¥ RSI æˆ– ADX æŒ‡æ¨™é€²è¡Œéæ¿¾ï¼Œä»¥æ¸›å°‘å‡ä¿¡è™Ÿã€‚');
    }

    /* --------- åˆå§‹åŠ è¼‰ --------- */
    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
    });
  </script>
</body>
</html>
