name: 更新任意股票日线（手动输入）

on:
  workflow_dispatch:
    inputs:
      symbols:
        description: "股票代码（美股/港股），多个用英文逗号分隔，如 AAPL,0700.HK,TSLA"
        required: true
        default: "AAPL,0700.HK"
      period:
        description: "周期"
        required: true
        default: "30d"
        type: choice
        options: ["1d","5d","30d","90d","180d","1y"]

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -U yfinance

      - name: 爬取并生成 JSON
        run: |
          python - <<'PY'
          import yfinance as yf, json, os

          raw_symbols = "${{ github.event.inputs.symbols }}".split(",")
          period      = "${{ github.event.inputs.period }}"
          os.makedirs('docs/data', exist_ok=True)

          for s in raw_symbols:
              s = s.strip().upper()
              # 港股 00700.HK → 0700.HK
              yahoo_sym = s.replace("00","0",1) if s.endswith(".HK") and s.startswith("00") else s
              try:
                  df = yf.Ticker(yahoo_sym).history(period=period, interval='1d', prepost=False)
                  if df.empty:
                      print(f'❌ {s} 无数据'); continue

                  out = []
                  for t, row in df.iterrows():
                      out.append({
                          "t": t.strftime('%Y-%m-%d'),
                          "o": round(float(row.Open), 2),
                          "h": round(float(row.High), 2),
                          "l": round(float(row.Low ), 2),
                          "c": round(float(row.Close),2),
                          "v": int(row.Volume)
                      })

                  file_name = s.replace(".","") + ".json"   # 0700.HK → 0700HK.json
                  with open(f'docs/data/{file_name}', 'w') as f:
                      json.dump(out, f, separators=(',', ':'))
                  print(f'✅ {s} → {file_name} 共 {len(out)} 条')
              except Exception as e:
                  print(f'❌ {s} 失败: {e}')
          PY

      - name: Commit & Push
        run: |
          git config user.name  'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add docs/data
          git diff --cached --quiet && echo "无更新" || (
            git commit -m "chore: 更新 ${{ github.event.inputs.symbols }} ${{ github.event.inputs.period }} 数据"
            git push
          )
