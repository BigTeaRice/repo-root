name: 每日股票数据（自动+手动）

on:
  schedule:
    - cron: '0 18 * * 1-5'   # 周一到五 18:00 UTC
  workflow_dispatch:
    inputs:
      symbols:
        description: "股票代码（美股/港股），多个用英文逗号分隔，如 AAPL,0700.HK,TSLA"
        required: false
        default: "AAPL,0700.HK,TSLA"
      period:
        description: "周期"
        required: false
        default: "30d"
        type: choice
        options: ["1d","5d","30d","90d","180d","1y"]

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: pip install -U yfinance

      - name: 爬取并生成 JSON
        run: |
          # 如果手动触发，用输入值；否则用默认值
          SYMBOLS="${{ github.event.inputs.symbols }}"
          PERIOD="${{ github.event.inputs.period }}"
          [ -z "$SYMBOLS" ] && SYMBOLS="AAPL,0700.HK,TSLA"
          [ -z "$PERIOD" ] && PERIOD="30d"
          python $GITHUB_WORKSPACE/crawl.py "$SYMBOLS" "$PERIOD"

      - name: Commit & Push
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add docs/data
          git diff --cached --quiet && echo "无更新" || (
            git commit -m "chore: 更新股票数据 $SYMBOLS $PERIOD"
            git push
          )
