name: 更新任意股票日线（手动输入）

on:
  workflow_dispatch:
    inputs:
      symbols:
        description: "股票代码（美股/港股），多个用英文逗号分隔，如 AAPL,0700.HK,TSLA"
        required: true
        default: "AAPL,0700.HK"
      period:
        description: "周期"
        required: true
        default: "30d"
        type: choice
        options: ["1d","5d","30d","90d","180d","1y"]

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        # 修正：安裝 requirements.txt 中的所有依賴 (yfinance, ta, flask 等)
        run: pip install -r requirements.txt 

      - name: 爬取并生成 JSON
        # 執行 crawl_any.py 腳本，將結果寫入 docs/data/
        run: |
          python $GITHUB_WORKSPACE/scripts/crawl_any.py \
            "${{ github.event.inputs.symbols }}" \
            "${{ github.event.inputs.period }}"

      - name: Commit & Push
        # 配置 Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 將 docs/data 資料夾下的所有變更加入追蹤
          git add docs/data
          
          # 檢查是否有實際更新，若無則輸出 "无更新"
          git diff --cached --quiet && echo "无更新" || (
            # 若有更新，則提交並推送到 GitHub
            git commit -m "chore: 更新 ${{ github.event.inputs.symbols }} ${{ github.event.inputs.period }} 数据"
            git push
          )
